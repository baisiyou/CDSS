<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drug Combination Analysis System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        /* Language switcher */
        .language-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }
        
        .lang-btn {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }
        
        .lang-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .lang-btn.active {
            background: rgba(255, 255, 255, 0.4);
            border-color: white;
            font-weight: bold;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .drug-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .drug-input-group {
            flex: 1;
            min-width: 300px;
        }
        
        .drug-input-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        .drug-search {
            position: relative;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px 40px 12px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        
        .drug-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .drug-dropdown.show {
            display: block;
        }
        
        .drug-option {
            padding: 12px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .drug-option:hover {
            background: #f0f4ff;
        }
        
        .drug-option:last-child {
            border-bottom: none;
        }
        
        .selected-drugs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .drug-tag {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: #667eea;
            color: white;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .drug-tag .remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
            line-height: 1;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        
        .drug-tag .remove:hover {
            opacity: 1;
        }
        
        .btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 20px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results {
            display: none;
        }
        
        .results.show {
            display: block;
        }
        
        .result-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .result-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .risk-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 10px;
        }
        
        .risk-high {
            background: #fee;
            color: #c33;
        }
        
        .risk-medium {
            background: #fff3cd;
            color: #856404;
        }
        
        .risk-low {
            background: #d4edda;
            color: #155724;
        }
        
        .risk-protective {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .combination-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }
        
        .combination-item h4 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-item {
            padding: 15px;
            background: white;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-item .label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .stat-item .value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .recommendations {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .recommendations h4 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .recommendations ul {
            margin-left: 20px;
            color: #856404;
        }
        
        .recommendations li {
            margin-bottom: 8px;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #dc3545;
        }
        
        .outcome-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        .outcome-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .outcome-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }
        
        .outcome-content {
            display: none;
        }
        
        .outcome-content.active {
            display: block;
        }
    </style>
    <!-- API configuration script - must be loaded before other scripts -->
    <script src="config.js"></script>
</head>
<body>
    <div class="container">
        <div class="header" style="position: relative;">
            <div class="language-switcher">
                <button class="lang-btn" onclick="switchLanguage('zh')" data-lang="zh">‰∏≠Êñá</button>
                <button class="lang-btn active" onclick="switchLanguage('en')" data-lang="en">English</button>
                <button class="lang-btn" onclick="switchLanguage('fr')" data-lang="fr">Fran√ßais</button>
            </div>
            <h1 id="title">üíä Drug Combination Analysis System</h1>
            <p id="subtitle">Analyze risks and efficacy of any drug combination</p>
        </div>
        
        <div class="content">
            <!-- Drug selection area -->
            <div class="section">
                <h2 id="section1Title">1. Select Drugs</h2>
                <div class="drug-selector">
                    <div class="drug-input-group">
                        <label id="drugSearchLabel">Search and add drugs (supports Chinese and English)</label>
                        <div class="drug-search">
                            <input type="text" id="drugSearch" data-placeholder-key="drugSearchPlaceholder">
                            <span class="search-icon">üîç</span>
                            <div class="drug-dropdown" id="drugDropdown"></div>
                        </div>
                        <div style="margin-top: 10px; font-size: 12px; color: #666;" id="drugSearchHint">
                            üí° Tip: Supports Chinese or English search (e.g., penicillin, aspirin, prednisone)
                        </div>
                    </div>
                </div>
                <div class="selected-drugs" id="selectedDrugs"></div>
                <button class="btn" id="analyzeBtn" onclick="analyzeCombination()" data-text-key="btnAnalyze">Start Analysis</button>
            </div>
            
            <!-- Loading state -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p id="loadingText">Analyzing drug combination, please wait...</p>
            </div>
            
            <!-- Results area -->
            <div class="results" id="results">
                <div class="section">
                    <h2 id="resultsTitle">Analysis Results</h2>
                    
                    <!-- Overall risk -->
                    <div class="result-card">
                        <h3 id="overallRiskTitle">Overall Risk Assessment</h3>
                        <div id="overallRisk"></div>
                    </div>
                    
                    <!-- Multi-organ dysfunction prediction -->
                    <div class="result-card">
                        <h3 id="organPredictionTitle">Multi-Organ Dysfunction Prediction</h3>
                        <div class="outcome-tabs" id="outcomeTabs"></div>
                        <div id="outcomeContent"></div>
                    </div>
                    
                    <!-- Recommendations -->
                    <div class="recommendations" id="recommendations"></div>
                </div>
            </div>
            
            <!-- Error message -->
            <div class="error" id="error" style="display: none;"></div>
        </div>
    </div>
    
    <script>
        // Support API address configuration via URL parameters or config.js
        // Priority: URL parameter > window.API_BASE_URL in config.js > default localhost
        const urlParams = new URLSearchParams(window.location.search);
        const API_BASE = urlParams.get('api') || 
                        (typeof window.API_BASE_URL !== 'undefined' ? window.API_BASE_URL : 'http://localhost:5003');
        let allDrugs = [];
        let selectedDrugs = [];
        let currentOrgan = 'kidney'; // Currently selected organ type
        let currentLanguage = localStorage.getItem('language') || 'en'; // Current language
        
        // Internationalization text resources
        const i18n = {
            zh: {
                title: 'üíä ËçØÁâ©ÁªÑÂêàÂàÜÊûêÁ≥ªÁªü',
                subtitle: 'ÂàÜÊûê‰ªªÊÑèËçØÁâ©ÁªÑÂêàÁöÑÈ£éÈô©ÂíåÁñóÊïà',
                section1Title: '1. ÈÄâÊã©ËçØÁâ©',
                drugSearchLabel: 'ÊêúÁ¥¢Âπ∂Ê∑ªÂä†ËçØÁâ©ÔºàÊîØÊåÅ‰∏≠ÊñáÂíåËã±ÊñáÔºâ',
                drugSearchPlaceholder: 'ËæìÂÖ•ËçØÁâ©ÂêçÁß∞ÊêúÁ¥¢ÔºàÂ¶ÇÔºöÈùíÈúâÁ¥†„ÄÅaspirin„ÄÅprednisoneÔºâ...',
                drugSearchHint: 'üí° ÊèêÁ§∫ÔºöÊîØÊåÅ‰∏≠ÊñáÊêúÁ¥¢ÔºàÂ¶ÇÔºöÈùíÈúâÁ¥†„ÄÅÈòøÂè∏ÂåπÊûó„ÄÅÈÜãÈÖ∏Ê≥ºÂ∞ºÊùæÔºâÔºå‰πüÂèØ‰ª•ËæìÂÖ•Ëã±ÊñáÂêçÁß∞',
                btnAnalyze: 'ÂºÄÂßãÂàÜÊûê',
                loadingText: 'Ê≠£Âú®ÂàÜÊûêËçØÁâ©ÁªÑÂêàÔºåËØ∑Á®çÂÄô...',
                resultsTitle: 'ÂàÜÊûêÁªìÊûú',
                overallRiskTitle: 'ÊÄª‰ΩìÈ£éÈô©ËØÑ‰º∞',
                organPredictionTitle: 'Â§öÂô®ÂÆòÂäüËÉΩÈöúÁ¢çÈ¢ÑÊµã',
                kidneyAbnormal: 'ËÇæÂäüËÉΩÂºÇÂ∏∏',
                liverAbnormal: 'ËÇùÂäüËÉΩÂºÇÂ∏∏',
                organAbnormal: 'Â§öÂô®ÂÆòÂäüËÉΩÈöúÁ¢ç',
                noDrugsSelected: 'ÊöÇÊó†Â∑≤ÈÄâËçØÁâ©',
                selectAtLeast2: 'ËØ∑Ëá≥Â∞ëÈÄâÊã©2ÁßçËçØÁâ©',
                currentSelected: 'ÂΩìÂâçÂ∑≤ÈÄâÊã©',
                drugs: 'ÁßçËçØÁâ©',
                selectedDrugs: 'Â∑≤ÈÄâËçØÁâ©',
                analyzing: 'ÂàÜÊûê‰∏≠...',
                errorApiConnection: 'Êó†Ê≥ïËøûÊé•Âà∞APIÊúçÂä°ÔºåËØ∑Á°Æ‰øùAPIÊúçÂä°Ê≠£Âú®ËøêË°å',
                errorApiTimeout: 'APIÊúçÂä°ÂìçÂ∫îË∂ÖÊó∂ÔºåÂÖçË¥πÁâàÊúçÂä°ÂèØËÉΩÈúÄË¶Å30ÁßíÂêØÂä®ÔºåËØ∑Á®çÂêéÈáçËØï',
                serviceStarting: 'ÊúçÂä°Ê≠£Âú®ÂêØÂä®‰∏≠ÔºåËØ∑Á®çÂÄô...ÔºàÈ¶ñÊ¨°ËÆøÈóÆÂèØËÉΩÈúÄË¶Å30ÁßíÔºâ',
                error503: 'ËçØÁâ©ÁªÑÂêàÂàÜÊûêÊúçÂä°ÊöÇÊó∂‰∏çÂèØÁî®',
                error503Cause: 'ÂèØËÉΩÂéüÂõ†',
                error503Solution: 'Ëß£ÂÜ≥ÊñπÊ°à',
                error503Cause1: 'ÊúçÂä°Ê≠£Âú®ÂêØÂä®‰∏≠ÔºàÈ¶ñÊ¨°ËÆøÈóÆÂèØËÉΩÈúÄË¶Å30-60ÁßíÔºâ',
                error503Cause2: 'ÂÜÖÂ≠òÈôêÂà∂ÂØºËá¥ÂÆåÊï¥Êï∞ÊçÆÊú™Âä†ËΩΩÔºàÂÖçË¥πÁâàÈôêÂà∂Ôºâ',
                error503Cause3: 'Êï∞ÊçÆÊñá‰ª∂Ê≠£Âú®‰∏ãËΩΩÊàñÂä†ËΩΩ‰∏≠',
                error503Solution1: 'Á≠âÂæÖ30-60ÁßíÂêéÈáçËØï',
                error503Solution2: 'Ê£ÄÊü•ÊúçÂä°ÂÅ•Â∫∑Áä∂ÊÄÅ',
                error503Solution3: 'Â¶ÇÊûúÊåÅÁª≠Â§±Ë¥•ÔºåÂèØËÉΩÈúÄË¶ÅÂçáÁ∫ßÂà∞‰ªòË¥πËÆ°Âàí‰ª•Âä†ËΩΩÂÆåÊï¥Êï∞ÊçÆ',
                errorNoDrugs: 'Êú™ÊâæÂà∞ÂåπÈÖçÁöÑËçØÁâ©',
                errorTryEnglish: 'ËØ∑Â∞ùËØïËæìÂÖ•Ëã±ÊñáÂêçÁß∞',
                predictionResult: 'È¢ÑÊµãÁªìÊûú',
                predictionStatus: 'È¢ÑÊµãÁä∂ÊÄÅ',
                abnormalProbability: 'ÂºÇÂ∏∏Ê¶ÇÁéá',
                riskLevel: 'È£éÈô©Á≠âÁ∫ß',
                highRisk: 'È´òÈ£éÈô©',
                mediumRisk: '‰∏≠Á≠âÈ£éÈô©',
                lowRisk: '‰ΩéÈ£éÈô©',
                normal: 'Ê≠£Â∏∏',
                abnormal: 'ÂºÇÂ∏∏',
                recommendations: '‰∏¥Â∫äÂª∫ËÆÆ',
                addDrug: 'Ê∑ªÂä†Ê≠§ËçØÁâ©',
                basedOn: 'Âü∫‰∫é',
                predict: 'È¢ÑÊµã',
                risk: 'È£éÈô©',
                noResults: 'Êú™ÂèëÁé∞ÊòéÊòæÁöÑ‰øùÊä§ÊÄßËÅîÁî®ÊïàÊûú',
                overallRiskLevel: 'ÊÄª‰ΩìÈ£éÈô©Á≠âÁ∫ß',
                averageRelativeRisk: 'Âπ≥ÂùáÁõ∏ÂØπÈ£éÈô©',
                maxRelativeRisk: 'ÊúÄÂ§ßÁõ∏ÂØπÈ£éÈô©',
                analyzedCombinations: 'ÂàÜÊûêÁªÑÂêàÊï∞',
                predictionResult: 'È¢ÑÊµãÁªìÊûú',
                suggestMonitor: 'È¢ÑÊµãÂèØËÉΩÂá∫Áé∞Âô®ÂÆòÂäüËÉΩÂºÇÂ∏∏ÔºåÂª∫ËÆÆÂØÜÂàáÁõëÊµãÁõ∏ÂÖ≥ÊåáÊ†áÔºàBUN„ÄÅINR„ÄÅÁôΩËõãÁôΩÁ≠âÔºâ',
                predictionNormal: 'ÂΩìÂâçÈ¢ÑÊµã‰∏∫Ê≠£Â∏∏ÔºåÁªßÁª≠ÁõëÊµã',
                solution: 'Ëß£ÂÜ≥ÊñπÊ°à',
                checkApiRunning: 'Ê£ÄÊü•APIÊúçÂä°ÊòØÂê¶Ê≠£Âú®ËøêË°å',
                checkApiHealth: 'ËÆøÈóÆÂÅ•Â∫∑Ê£ÄÊü•Á´ØÁÇπÊü•ÁúãÊúçÂä°Áä∂ÊÄÅ',
                restartApi: 'Â¶ÇÊûúÊ®°ÂûãÊú™Âä†ËΩΩÔºåÈáçÂêØAPIÊúçÂä°',
                checkApiLogs: 'Êü•ÁúãAPIÂêØÂä®Êó•ÂøóÔºåÁ°ÆËÆ§Ê®°ÂûãÂä†ËΩΩÊàêÂäü',
                modelNotLoaded: 'È¢ÑÊµãÊ®°ÂûãÊú™Âä†ËΩΩ',
                drugAlreadySelected: 'ËØ•ËçØÁâ©Â∑≤Âú®ÈÄâÊã©ÂàóË°®‰∏≠',
                foundChineseButNoEnglish: 'ÊâæÂà∞‰∏≠ÊñáÂêçÁß∞Ôºå‰ΩÜÊú™Âú®ËçØÁâ©ÂàóË°®‰∏≠ÊâæÂà∞ÂØπÂ∫îÁöÑËã±ÊñáËçØÁâ©',
                suggestTryEnglish: 'Âª∫ËÆÆÔºöÂ∞ùËØïËæìÂÖ•Ëã±ÊñáÂêçÁß∞',
                noMatchingDrugs: 'Êú™ÊâæÂà∞ÂåπÈÖçÁöÑËçØÁâ©',
                chineseNotInMap: 'ËØ•‰∏≠ÊñáÂêçÁß∞ÂèØËÉΩ‰∏çÂú®Êò†Â∞ÑË°®‰∏≠',
                tryCommonDrugs: 'ÊàñÂ∞ùËØïÂ∏∏ËßÅËçØÁâ©',
                checkSpelling: 'ËØ∑Ê£ÄÊü•ÊãºÂÜôÊòØÂê¶Ê≠£Á°Æ',
                tryPartialName: 'ÊàñÂ∞ùËØïËæìÂÖ•ÈÉ®ÂàÜÂêçÁß∞',
                preventOrganDysfunction: 'Èò≤Ê≠¢Â§öÂô®ÂÆòÂäüËÉΩÈöúÁ¢çÁöÑÊé®ËçêËçØÁâ©',
                basedOnAnalysis: 'Âü∫‰∫éÊï∞ÊçÆÂàÜÊûêÂíå‰∏¥Â∫äÁü•ËØÜÔºå‰ª•‰∏ãËçØÁâ©ÂèØËÉΩÊúâÂä©‰∫éÈôç‰ΩéÂô®ÂÆòÂäüËÉΩÂºÇÂ∏∏È£éÈô©',
                detectedRisk: 'Ê£ÄÊµãÂà∞Âô®ÂÆòÂäüËÉΩÂºÇÂ∏∏È£éÈô©ÔºåÂª∫ËÆÆËÄÉËôëÊ∑ªÂä†‰øùÊä§ÊÄßËçØÁâ©',
                recommendedReason: 'Êé®ËçêÁêÜÁî±',
                riskReduction: '‰º∞ËÆ°È£éÈô©Èôç‰Ωé',
                addThisDrug: 'Ê∑ªÂä†Ê≠§ËçØÁâ©',
                noteRecommendations: '‚ö†Ô∏è Ê≥®ÊÑèÔºöÊé®ËçêËçØÁâ©‰ªÖ‰æõÂèÇËÄÉÔºåÂÆûÈôÖÁî®ËçØÈúÄÁªìÂêà‰∏¥Â∫äÂà§Êñ≠ÂíåÊÇ£ËÄÖÂÖ∑‰ΩìÊÉÖÂÜµ',
                clinicalRecommendations: '‰∏¥Â∫äÂª∫ËÆÆ',
                noData: 'ÊöÇÊó†Áõ∏ÂÖ≥Êï∞ÊçÆ',
                riskyCombinations: 'È´òÈ£éÈô©ËçØÁâ©ÁªÑÂêà',
                effectiveCombinations: 'ÊúâÊïàËçØÁâ©ÁªÑÂêà',
                relativeRisk: 'Áõ∏ÂØπÈ£éÈô©',
                comboWith: '‰∏é',
                comboWithSuffix: 'ËÅîÁî®',
                potentialRiskReduction: 'ÊΩúÂú®È£éÈô©Èôç‰Ωé',
                drugRecommendation: 'ËçØÁâ©Êé®Ëçê',
                noRecommendationData: 'Ê£ÄÊµãÂà∞Âô®ÂÆòÂäüËÉΩÂºÇÂ∏∏È£éÈô©Ôºå‰ΩÜÊöÇÊó†Êé®ËçêËçØÁâ©Êï∞ÊçÆ',
                suggestionAntioxidant: 'Âª∫ËÆÆÔºöËÄÉËôë‰ΩøÁî®ÊäóÊ∞ßÂåñÂâÇÔºàÂ¶ÇN-‰πôÈÖ∞ÂçäËÉ±Ê∞®ÈÖ∏Ôºâ„ÄÅÁª¥ÁîüÁ¥†Á±ª„ÄÅÊàñÊ†πÊçÆ‰∏¥Â∫äÊåáÂçó‰ΩøÁî®Âô®ÂÆò‰øùÊä§ÊÄßËçØÁâ©'
            },
            en: {
                title: 'üíä Drug Combination Analysis System',
                subtitle: 'Analyze risks and efficacy of any drug combination',
                section1Title: '1. Select Drugs',
                drugSearchLabel: 'Search and add drugs (supports Chinese and English)',
                drugSearchPlaceholder: 'Enter drug name to search (e.g., penicillin, aspirin, prednisone)...',
                drugSearchHint: 'üí° Tip: Supports Chinese or English search (e.g., penicillin, aspirin, prednisone)',
                btnAnalyze: 'Start Analysis',
                loadingText: 'Analyzing drug combination, please wait...',
                resultsTitle: 'Analysis Results',
                overallRiskTitle: 'Overall Risk Assessment',
                organPredictionTitle: 'Multi-Organ Dysfunction Prediction',
                kidneyAbnormal: 'Kidney Dysfunction',
                liverAbnormal: 'Liver Dysfunction',
                organAbnormal: 'Multi-Organ Dysfunction',
                noDrugsSelected: 'No drugs selected',
                selectAtLeast2: 'Please select at least 2 drugs',
                currentSelected: 'Currently selected',
                drugs: 'drugs',
                selectedDrugs: 'Selected drugs',
                analyzing: 'Analyzing...',
                errorApiConnection: 'Cannot connect to API service, please ensure the API service is running',
                errorApiTimeout: 'API service timeout, free tier service may need 30 seconds to start, please retry later',
                serviceStarting: 'Service is starting, please wait... (First access may take 30 seconds)',
                error503: 'Drug combination analysis service temporarily unavailable',
                error503Cause: 'Possible causes',
                error503Solution: 'Solutions',
                error503Cause1: 'Service is starting (first access may take 30-60 seconds)',
                error503Cause2: 'Memory limit preventing full data load (free tier)',
                error503Cause3: 'Data file is downloading or loading',
                error503Solution1: 'Wait 30-60 seconds and retry',
                error503Solution2: 'Check service health status',
                error503Solution3: 'If failure persists, upgrade to paid plan may be needed',
                errorNoDrugs: 'No matching drugs found',
                errorTryEnglish: 'Please try entering English names',
                predictionResult: 'Prediction Result',
                predictionStatus: 'Prediction Status',
                abnormalProbability: 'Abnormal Probability',
                riskLevel: 'Risk Level',
                highRisk: 'High Risk',
                mediumRisk: 'Medium Risk',
                lowRisk: 'Low Risk',
                normal: 'Normal',
                abnormal: 'Abnormal',
                recommendations: 'Clinical Recommendations',
                addDrug: 'Add This Drug',
                basedOn: 'Based on',
                predict: 'predict',
                risk: 'risk',
                noResults: 'No significant protective combination effects found',
                overallRiskLevel: 'Overall Risk Level',
                averageRelativeRisk: 'Average Relative Risk',
                maxRelativeRisk: 'Max Relative Risk',
                analyzedCombinations: 'Analyzed Combinations',
                predictionResult: 'Prediction Result',
                suggestMonitor: 'Organ dysfunction may occur, closely monitor relevant indicators (BUN, INR, albumin, etc.)',
                predictionNormal: 'Current prediction is normal, continue monitoring',
                solution: 'Solution',
                checkApiRunning: 'Check if API service is running',
                checkApiHealth: 'Visit health check endpoint to view service status',
                restartApi: 'If model is not loaded, restart API service',
                checkApiLogs: 'Check API startup logs to confirm model loading',
                modelNotLoaded: 'Prediction model not loaded',
                drugAlreadySelected: 'This drug is already in the selection list',
                foundChineseButNoEnglish: 'Found Chinese name but no corresponding English drug in the list',
                suggestTryEnglish: 'Suggestion: Try entering English names',
                noMatchingDrugs: 'No matching drugs found',
                chineseNotInMap: 'This Chinese name may not be in the mapping table',
                tryCommonDrugs: 'Or try common drugs',
                checkSpelling: 'Please check if spelling is correct',
                tryPartialName: 'Or try entering partial name',
                preventOrganDysfunction: 'Recommended Drugs to Prevent Multi-Organ Dysfunction',
                basedOnAnalysis: 'Based on data analysis and clinical knowledge, the following drugs may help reduce organ dysfunction risk',
                detectedRisk: 'Organ dysfunction risk detected, consider adding protective drugs',
                recommendedReason: 'Recommended Reason',
                riskReduction: 'Estimated Risk Reduction',
                addThisDrug: 'Add This Drug',
                noteRecommendations: 'Note: Recommended drugs are for reference only, actual use should be combined with clinical judgment and patient-specific situation',
                clinicalRecommendations: 'Clinical Recommendations',
                noData: 'No relevant data',
                riskyCombinations: 'High-Risk Drug Combinations',
                effectiveCombinations: 'Effective Drug Combinations',
                relativeRisk: 'Relative Risk',
                comboWith: 'with',
                comboWithSuffix: 'combination',
                potentialRiskReduction: 'Potential Risk Reduction',
                drugRecommendation: 'Drug Recommendation',
                noRecommendationData: 'Organ dysfunction risk detected, but no recommendation data available',
                suggestionAntioxidant: 'Suggestion: Consider using antioxidants (e.g., N-acetylcysteine), vitamins, or organ-protective drugs according to clinical guidelines'
            },
            fr: {
                title: 'üíä Syst√®me d\'Analyse de Combinaisons M√©dicamenteuses',
                subtitle: 'Analyser les risques et l\'efficacit√© de toute combinaison de m√©dicaments',
                section1Title: '1. S√©lectionner les M√©dicaments',
                drugSearchLabel: 'Rechercher et ajouter des m√©dicaments (supporte le chinois et l\'anglais)',
                drugSearchPlaceholder: 'Entrez le nom du m√©dicament √† rechercher (ex: p√©nicilline, aspirine, prednisone)...',
                drugSearchHint: 'üí° Astuce: Supporte la recherche en chinois ou en anglais (ex: p√©nicilline, aspirine, prednisone)',
                btnAnalyze: 'D√©marrer l\'Analyse',
                loadingText: 'Analyse de la combinaison de m√©dicaments en cours, veuillez patienter...',
                resultsTitle: 'R√©sultats de l\'Analyse',
                overallRiskTitle: '√âvaluation Globale des Risques',
                organPredictionTitle: 'Pr√©diction de Dysfonctionnement Multi-Organes',
                kidneyAbnormal: 'Dysfonctionnement R√©nal',
                liverAbnormal: 'Dysfonctionnement H√©patique',
                organAbnormal: 'Dysfonctionnement Multi-Organes',
                noDrugsSelected: 'Aucun m√©dicament s√©lectionn√©',
                selectAtLeast2: 'Veuillez s√©lectionner au moins 2 m√©dicaments',
                currentSelected: 'Actuellement s√©lectionn√©',
                drugs: 'm√©dicaments',
                selectedDrugs: 'M√©dicaments s√©lectionn√©s',
                analyzing: 'Analyse en cours...',
                errorApiConnection: 'Impossible de se connecter au service API, veuillez vous assurer que le service API est en cours d\'ex√©cution',
                errorApiTimeout: 'D√©lai d\'attente du service API d√©pass√©, le service gratuit peut n√©cessiter 30 secondes pour d√©marrer, veuillez r√©essayer plus tard',
                serviceStarting: 'Le service d√©marre, veuillez patienter... (Le premier acc√®s peut prendre 30 secondes)',
                error503: 'Service d\'analyse de combinaison de m√©dicaments temporairement indisponible',
                error503Cause: 'Causes possibles',
                error503Solution: 'Solutions',
                error503Cause1: 'Le service d√©marre (premier acc√®s peut prendre 30-60 secondes)',
                error503Cause2: 'Limite de m√©moire emp√™chant le chargement complet des donn√©es (version gratuite)',
                error503Cause3: 'Fichier de donn√©es en cours de t√©l√©chargement ou de chargement',
                error503Solution1: 'Attendre 30-60 secondes puis r√©essayer',
                error503Solution2: 'V√©rifier l\'√©tat du service',
                error503Solution3: 'Si l\'√©chec persiste, une mise √† niveau vers un plan payant peut √™tre n√©cessaire',
                errorNoDrugs: 'Aucun m√©dicament correspondant trouv√©',
                errorTryEnglish: 'Veuillez essayer d\'entrer des noms anglais',
                predictionResult: 'R√©sultat de la Pr√©diction',
                predictionStatus: 'Statut de la Pr√©diction',
                abnormalProbability: 'Probabilit√© d\'Anomalie',
                riskLevel: 'Niveau de Risque',
                highRisk: 'Risque √âlev√©',
                mediumRisk: 'Risque Moyen',
                lowRisk: 'Risque Faible',
                normal: 'Normal',
                abnormal: 'Anormal',
                recommendations: 'Recommandations Cliniques',
                addDrug: 'Ajouter ce M√©dicament',
                basedOn: 'Bas√© sur',
                predict: 'pr√©dire',
                risk: 'risque',
                noResults: 'Aucun effet protecteur significatif de combinaison trouv√©',
                overallRiskLevel: 'Niveau de Risque Global',
                averageRelativeRisk: 'Risque Relatif Moyen',
                maxRelativeRisk: 'Risque Relatif Maximum',
                analyzedCombinations: 'Combinaisons Analys√©es',
                predictionResult: 'R√©sultat de la Pr√©diction',
                suggestMonitor: 'Un dysfonctionnement d\'organe peut survenir, surveiller de pr√®s les indicateurs pertinents (BUN, INR, albumine, etc.)',
                predictionNormal: 'La pr√©diction actuelle est normale, continuer la surveillance',
                solution: 'Solution',
                checkApiRunning: 'V√©rifier si le service API est en cours d\'ex√©cution',
                checkApiHealth: 'Visiter le point de contr√¥le de sant√© pour voir l\'√©tat du service',
                restartApi: 'Si le mod√®le n\'est pas charg√©, red√©marrer le service API',
                checkApiLogs: 'V√©rifier les journaux de d√©marrage de l\'API pour confirmer le chargement du mod√®le',
                modelNotLoaded: 'Mod√®le de pr√©diction non charg√©',
                drugAlreadySelected: 'Ce m√©dicament est d√©j√† dans la liste de s√©lection',
                foundChineseButNoEnglish: 'Nom chinois trouv√© mais aucun m√©dicament anglais correspondant dans la liste',
                suggestTryEnglish: 'Suggestion: Essayez d\'entrer des noms anglais',
                noMatchingDrugs: 'Aucun m√©dicament correspondant trouv√©',
                chineseNotInMap: 'Ce nom chinois peut ne pas √™tre dans la table de correspondance',
                tryCommonDrugs: 'Ou essayez des m√©dicaments courants',
                checkSpelling: 'Veuillez v√©rifier si l\'orthographe est correcte',
                tryPartialName: 'Ou essayez d\'entrer un nom partiel',
                preventOrganDysfunction: 'M√©dicaments Recommand√©s pour Pr√©venir le Dysfonctionnement Multi-Organes',
                basedOnAnalysis: 'Bas√© sur l\'analyse des donn√©es et les connaissances cliniques, les m√©dicaments suivants peuvent aider √† r√©duire le risque de dysfonctionnement d\'organe',
                detectedRisk: 'Risque de dysfonctionnement d\'organe d√©tect√©, envisager d\'ajouter des m√©dicaments protecteurs',
                recommendedReason: 'Raison de la Recommandation',
                riskReduction: 'R√©duction du Risque Estim√©e',
                addThisDrug: 'Ajouter ce M√©dicament',
                noteRecommendations: 'Note: Les m√©dicaments recommand√©s sont √† titre indicatif uniquement, l\'utilisation r√©elle doit √™tre combin√©e avec le jugement clinique et la situation sp√©cifique du patient',
                clinicalRecommendations: 'Recommandations Cliniques',
                noData: 'Aucune donn√©e pertinente',
                riskyCombinations: 'Combinaisons de M√©dicaments √† Risque √âlev√©',
                effectiveCombinations: 'Combinaisons de M√©dicaments Efficaces',
                relativeRisk: 'Risque Relatif',
                comboWith: 'avec',
                comboWithSuffix: 'combinaison',
                potentialRiskReduction: 'R√©duction Potentielle du Risque',
                drugRecommendation: 'Recommandation de M√©dicament',
                noRecommendationData: 'Risque de dysfonctionnement d\'organe d√©tect√©, mais aucune donn√©e de recommandation disponible',
                suggestionAntioxidant: 'Suggestion: Envisager d\'utiliser des antioxydants (par ex., N-ac√©tylcyst√©ine), des vitamines, ou des m√©dicaments protecteurs d\'organes selon les directives cliniques'
            }
        };
        
        // Get translated text
        function t(key) {
            return i18n[currentLanguage][key] || key;
        }
        
        // Translate interpretation text returned from backend
        function translateInterpretation(interpretation) {
            if (!interpretation) return '';
            
            // If current language is Chinese, return directly
            if (currentLanguage === 'zh') {
                return interpretation;
            }
            
            // Translate Chinese interpretation to English or French
            const translations = {
                'È´òÈ£éÈô©ÔºöËØ•ËçØÁâ©ÁªÑÂêàÊòæËëóÂ¢ûÂä†‰∏çËâØÁªìÂ±ÄÈ£éÈô©': {
                    en: 'High Risk: This drug combination significantly increases adverse outcome risk',
                    fr: 'Risque √âlev√©: Cette combinaison de m√©dicaments augmente significativement le risque d\'issue d√©favorable'
                },
                '‰∏≠Á≠âÈ£éÈô©ÔºöËØ•ËçØÁâ©ÁªÑÂêàÂèØËÉΩÂ¢ûÂä†‰∏çËâØÁªìÂ±ÄÈ£éÈô©': {
                    en: 'Medium Risk: This drug combination may increase adverse outcome risk',
                    fr: 'Risque Moyen: Cette combinaison de m√©dicaments peut augmenter le risque d\'issue d√©favorable'
                },
                '‰øùÊä§ÊÄßÔºöËØ•ËçØÁâ©ÁªÑÂêàÂèØËÉΩÈôç‰Ωé‰∏çËâØÁªìÂ±ÄÈ£éÈô©': {
                    en: 'Protective: This drug combination may reduce adverse outcome risk',
                    fr: 'Protecteur: Cette combinaison de m√©dicaments peut r√©duire le risque d\'issue d√©favorable'
                },
                'ÂèØËÉΩ‰øùÊä§ÊÄßÔºöËØ•ËçØÁâ©ÁªÑÂêàÂèØËÉΩÁï•ÂæÆÈôç‰Ωé‰∏çËâØÁªìÂ±ÄÈ£éÈô©': {
                    en: 'Potentially Protective: This drug combination may slightly reduce adverse outcome risk',
                    fr: 'Potentiellement Protecteur: Cette combinaison de m√©dicaments peut l√©g√®rement r√©duire le risque d\'issue d√©favorable'
                },
                '‰∏≠ÊÄßÔºöËØ•ËçØÁâ©ÁªÑÂêàÂØπÁªìÂ±ÄÂΩ±Âìç‰∏çÊòéÊòæ': {
                    en: 'Neutral: This drug combination has no significant effect on outcomes',
                    fr: 'Neutre: Cette combinaison de m√©dicaments n\'a pas d\'effet significatif sur les issues'
                }
            };
            
            // Exact match
            if (translations[interpretation]) {
                return translations[interpretation][currentLanguage] || interpretation;
            }
            
            // Partial match (handle possible variants)
            for (const [chinese, trans] of Object.entries(translations)) {
                if (interpretation.includes(chinese.split('Ôºö')[0]) || interpretation.includes(chinese.split('Ôºö')[1])) {
                    return trans[currentLanguage] || interpretation;
                }
            }
            
            // If cannot translate, return original text
            return interpretation;
        }
        
        // Switch language
        function switchLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            
            // Update language button state
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-lang') === lang) {
                    btn.classList.add('active');
                }
            });
            
            // Update HTML lang attribute
            document.documentElement.lang = lang === 'zh' ? 'zh-CN' : lang;
            
            // Update all texts
            updateTexts();
        }
        
        // Update all text content
        function updateTexts() {
            // Update title and subtitle
            document.getElementById('title').textContent = t('title');
            document.getElementById('subtitle').textContent = t('subtitle');
            
            // Update form labels
            document.getElementById('section1Title').textContent = t('section1Title');
            document.getElementById('drugSearchLabel').textContent = t('drugSearchLabel');
            document.getElementById('drugSearch').placeholder = t('drugSearchPlaceholder');
            document.getElementById('drugSearchHint').textContent = t('drugSearchHint');
            document.getElementById('analyzeBtn').textContent = t('btnAnalyze');
            
            // Update loading text
            document.getElementById('loadingText').textContent = t('loadingText');
            
            // Update result titles
            document.getElementById('resultsTitle').textContent = t('resultsTitle');
            document.getElementById('overallRiskTitle').textContent = t('overallRiskTitle');
            document.getElementById('organPredictionTitle').textContent = t('organPredictionTitle');
            
            // Update selected drugs display
            updateSelectedDrugs();
        }
        
        // Chinese drug name mapping (extended version)
        const drugNameMap = {
            'ÈùíÈúâÁ¥†': ['penicillin', 'piperacillin', 'nafcillin', 'ampicillin', 'amoxicillin'],
            'ÈòøÂè∏ÂåπÊûó': ['aspirin'],
            'ÈòøÂè∏Âåπ': ['aspirin'],
            'ÈÜãÈÖ∏Ê≥ºÂ∞ºÊùæ': ['prednisone', 'deltasone', 'methylprednisolone'],
            'Ê≥ºÂ∞ºÊùæ': ['prednisone', 'deltasone'],
            'Ê≥ºÂ∞º': ['prednisone', 'deltasone'],
            'Â§¥Â≠¢': ['cefazolin', 'ceftriaxone', 'cefepime', 'cephulac', 'cefuroxime'],
            'Â§¥Â≠¢Êõ≤Êùæ': ['ceftriaxone'],
            'Â§¥Â≠¢ÂîëÊûó': ['cefazolin'],
            'Â§¥Â≠¢‰ªñÂï∂': ['ceftazidime'],
            '‰∏áÂè§ÈúâÁ¥†': ['vancomycin'],
            'ÂëãÂ°ûÁ±≥': ['furosemide'],
            'Â∏ÉÁæé‰ªñÂ∞º': ['bumetanide', 'bumex'],
            'ÂØπ‰πôÈÖ∞Ê∞®Âü∫ÈÖö': ['acetaminophen', 'acetamin', 'tylenol'],
            '‰ªñÊ±Ä': ['atorvastatin', 'simvastatin', 'lipitor', 'zocor'],
            'ÈòøÊâò‰ºê‰ªñÊ±Ä': ['atorvastatin', 'lipitor'],
            'Ëæõ‰ºê‰ªñÊ±Ä': ['simvastatin', 'zocor'],
            'ËÉ∞Â≤õÁ¥†': ['insulin', 'humulin', 'lantus', 'levemir', 'glargine', 'lispro', 'detemir'],
            'ËÇùÁ¥†': ['heparin'],
            'Âú∞Â°ûÁ±≥Êùæ': ['dexamethasone', 'decadron'],
            'Áî≤Ê≥ºÂ∞ºÈæô': ['methylprednisolone', 'medrol'],
            'ÁéØ‰∏ôÊ≤ôÊòü': ['ciprofloxacin'],
            'Â∑¶Ê∞ßÊ∞üÊ≤ôÊòü': ['levofloxacin', 'levaquin'],
            'ÈòøÂ•áÈúâÁ¥†': ['azithromycin'],
            'ÁæéÁΩóÂüπÂçó': ['meropenem', 'merrem'],
            'ÂìåÊãâË•øÊûó': ['piperacillin', 'zosyn'],
            'ÂÖãÊûóÈúâÁ¥†': ['clindamycin'],
            'Áî≤Á°ùÂîë': ['metronidazole', 'flagyl'],
            'ÈòøËé´Ë•øÊûó': ['amoxicillin', 'amoxil'],
            'Ê∞®ËãÑË•øÊûó': ['ampicillin'],
            'Â∫ÜÂ§ßÈúâÁ¥†': ['gentamicin'],
            'Â¶•Â∏ÉÈúâÁ¥†': ['tobramycin'],
            'Â§öË•øÁéØÁ¥†': ['doxycycline'],
            'Á±≥ËØ∫ÁéØÁ¥†': ['minocycline'],
            'Á∫¢ÈúâÁ¥†': ['erythromycin'],
            'ÂÖãÊãâÈúâÁ¥†': ['clarithromycin'],
            'Ëé´Ë•øÊ≤ôÊòü': ['moxifloxacin'],
            'ËØ∫Ê∞üÊ≤ôÊòü': ['norfloxacin'],
            'Ê∞ßÊ∞üÊ≤ôÊòü': ['ofloxacin'],
            'Âà©Á¶èÂπ≥': ['rifampin', 'rifampicin'],
            'ÂºÇÁÉüËÇº': ['isoniazid'],
            '‰πôËÉ∫‰∏ÅÈÜá': ['ethambutol'],
            'Âê°Âó™ÈÖ∞ËÉ∫': ['pyrazinamide']
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Apply saved language settings
            switchLanguage(currentLanguage);
            loadDrugs();
            setupDrugSearch();
        });
        
        // Fetch function with timeout and retry
        async function fetchWithTimeout(url, options = {}, timeout = 45000, maxRetries = 1) {
            let lastError = null;
            
            for (let attempt = 0; attempt <= maxRetries; attempt++) {
                try {
                    if (attempt > 0) {
                        // Wait before retry, wait time increases with each retry
                        const waitTime = Math.min(1000 * Math.pow(2, attempt - 1), 5000);
                        console.log(`Attempt ${attempt + 1}, waiting ${waitTime}ms...`);
                        await new Promise(resolve => setTimeout(resolve, waitTime));
                    }
                    
                    // Create new controller for each attempt
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), timeout);
                    
                    try {
                        const response = await fetch(url, {
                            ...options,
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        // Even if response is not successful, return response object so caller can read error info
                        // Only throw error on network errors or timeouts
                        return response;
                    } finally {
                        clearTimeout(timeoutId);
                    }
                } catch (error) {
                    lastError = error;
                    
                    // If timeout or network error, and retries available, continue retrying
                    // HTTP error status codes (e.g., 503, 500) don't retry, return directly
                    if (attempt < maxRetries && (error.name === 'AbortError' || error.name === 'TypeError')) {
                        console.warn(`Request failed (attempt ${attempt + 1}/${maxRetries + 1}):`, error.message);
                        continue;
                    }
                    
                    // If last attempt or not retryable error, throw error
                    throw error;
                }
            }
            
            throw lastError || new Error('Request failed');
        }
        
        // Load all drug list
        async function loadDrugs() {
            try {
                console.log(`Connecting to API: ${API_BASE}`);
                // Show startup hint on first attempt
                const loadingHint = document.getElementById('drugSearchHint');
                if (loadingHint) {
                    const originalText = loadingHint.textContent;
                    loadingHint.textContent = t('serviceStarting');
                    loadingHint.style.color = '#667eea';
                }
                
                const response = await fetchWithTimeout(
                    `${API_BASE}/drugs/list?limit=1000`,
                    {},
                    45000, // 45 second timeout (Render free tier may need 30 seconds to start)
                    1      // Maximum 1 retry (2 attempts total)
                );
                
                const data = await response.json();
                if (data.success) {
                    allDrugs = data.drugs;
                    console.log(`‚úÖ Loaded ${allDrugs.length} drugs`);
                    
                    // Restore hint text
                    if (loadingHint) {
                        loadingHint.textContent = t('drugSearchHint');
                        loadingHint.style.color = '#666';
                    }
                }
            } catch (error) {
                console.error('‚ùå Failed to load drug list:', error);
                
                // Restore hint text
                const loadingHint = document.getElementById('drugSearchHint');
                if (loadingHint) {
                    loadingHint.textContent = t('drugSearchHint');
                    loadingHint.style.color = '#666';
                }
                
                // Display different error messages based on error type
                if (error.name === 'AbortError') {
                    showError(t('errorApiTimeout'));
                } else {
                    showError(t('errorApiConnection') + ' ' + error.message);
                }
            }
        }
        
        // Convert Chinese search to English (improved version, supports partial matching and fuzzy search)
        function translateChineseToEnglish(query) {
            const lowerQuery = query.toLowerCase().trim();
            if (!lowerQuery) return null;
            
            // Exact match
            for (const [chinese, englishNames] of Object.entries(drugNameMap)) {
                if (chinese === lowerQuery || lowerQuery === chinese) {
                    return englishNames;
                }
            }
            
            // Partial match (Chinese contains query or query contains Chinese)
            for (const [chinese, englishNames] of Object.entries(drugNameMap)) {
                if (chinese.includes(lowerQuery) || lowerQuery.includes(chinese)) {
                    return englishNames;
                }
            }
            
            // Fuzzy match: check if query contains part of Chinese name (only when query length >= 2, avoid single character matching too many results)
            if (query.length >= 2) {
            for (const [chinese, englishNames] of Object.entries(drugNameMap)) {
                // Check if query contains any characters from Chinese name
                const chineseChars = chinese.split('');
                const queryChars = lowerQuery.split('');
                // If characters in query appear in Chinese name, may be a match
                    // But require at least 2 characters matched, or query is the beginning part of Chinese name
                    const matchedChars = queryChars.filter(qc => chineseChars.includes(qc)).length;
                    if (matchedChars >= 2 || chinese.startsWith(lowerQuery) || lowerQuery.startsWith(chinese.substring(0, Math.min(query.length, chinese.length)))) {
                    return englishNames;
                    }
                }
            }
            
            return null;
        }
        
        // Reverse lookup: find corresponding Chinese name from English drug name
        function getChineseDrugName(englishDrug) {
            if (!englishDrug) return null;
            const lowerDrug = englishDrug.toLowerCase();
            
            for (const [chinese, englishNames] of Object.entries(drugNameMap)) {
                if (englishNames.some(en => lowerDrug.includes(en.toLowerCase()) || en.toLowerCase().includes(lowerDrug))) {
                    return chinese;
                }
            }
            return null;
        }
        
        // Setup drug search
        function setupDrugSearch() {
            const searchInput = document.getElementById('drugSearch');
            const dropdown = document.getElementById('drugDropdown');
            
            searchInput.addEventListener('input', function() {
                const query = this.value.trim();
                if (query.length < 1) {
                    dropdown.classList.remove('show');
                    return;
                }
                
                let filtered = [];
                const lowerQuery = query.toLowerCase();
                
                // 1. First check if it's a Chinese drug name
                const translated = translateChineseToEnglish(query);
                if (translated) {
                    // If drug list is empty, show friendly hint
                    if (allDrugs.length === 0) {
                        dropdown.innerHTML = `
                            <div class="drug-option" style="color: #ff9800; cursor: default;">
                                ‚ö†Ô∏è ${t('errorApiConnection')}
                            </div>
                            <div class="drug-option" style="color: #666; cursor: default; font-size: 12px;">
                                ${t('drugSearchHint')}
                            </div>
                        `;
                        dropdown.classList.add('show');
                        return;
                    }
                    
                    // Find matching English drugs (supports partial matching)
                    filtered = allDrugs.filter(drug => {
                        const lowerDrug = drug.toLowerCase();
                        return translated.some(en => {
                            const lowerEn = en.toLowerCase();
                            // Exact match or contains match
                            return lowerDrug === lowerEn || 
                                   lowerDrug.includes(lowerEn) || 
                                   lowerEn.includes(lowerDrug);
                        });
                    }).slice(0, 20);
                    
                    // Show Chinese hint (only show Chinese name in Chinese language environment)
                    if (filtered.length > 0) {
                        dropdown.innerHTML = filtered.map(drug => {
                            // Only show Chinese name in Chinese environment
                            if (currentLanguage === 'zh') {
                                const chineseName = getChineseDrugName(drug);
                                const displayName = chineseName ? `${drug} (${chineseName})` : drug;
                                return `<div class="drug-option" onclick="selectDrug('${drug}')">${displayName}</div>`;
                            } else {
                                return `<div class="drug-option" onclick="selectDrug('${drug}')">${drug}</div>`;
                            }
                        }).join('');
                        dropdown.classList.add('show');
                        return;
                    } else {
                        // Found Chinese mapping but couldn't find corresponding English drug in list
                        // Show suggested English names and hint that can directly input English names to search
                        dropdown.innerHTML = `
                            <div class="drug-option" style="color: #ff9800; cursor: default;">
                                ‚ö†Ô∏è ${t('foundChineseButNoEnglish')}
                            </div>
                            <div class="drug-option" style="color: #666; cursor: default; font-size: 12px;">
                                ${t('suggestTryEnglish')}: ${translated.slice(0, 3).join(', ')}
                            </div>
                            <div class="drug-option" style="color: #666; cursor: default; font-size: 11px; margin-top: 5px;">
                                üí° ${currentLanguage === 'zh' ? 'ÊèêÁ§∫ÔºöÊÇ®‰πüÂèØ‰ª•Áõ¥Êé•ËæìÂÖ•Ëã±ÊñáÂêçÁß∞ËøõË°åÊêúÁ¥¢' : currentLanguage === 'fr' ? 'Astuce : Vous pouvez √©galement taper directement des noms anglais pour rechercher' : 'Tip: You can also type English names directly'}
                            </div>
                        `;
                        dropdown.classList.add('show');
                        return;
                    }
                }
                
                // 2. English search
                filtered = allDrugs.filter(drug => 
                    drug.toLowerCase().includes(lowerQuery)
                ).slice(0, 20);
                
                if (filtered.length > 0) {
                    dropdown.innerHTML = filtered.map(drug => 
                        `<div class="drug-option" onclick="selectDrug('${drug}')">${drug}</div>`
                    ).join('');
                    dropdown.classList.add('show');
                } else {
                    // No match found, provide help information
                    let helpText = t('noMatchingDrugs');
                    let suggestions = [];
                    
                    // Check if it's Chinese input but not in mapping table
                    const isChinese = /[\u4e00-\u9fa5]/.test(query);
                    if (isChinese) {
                        helpText = `${t('noMatchingDrugs')}: "${query}"`;
                        suggestions.push(t('chineseNotInMap'));
                        suggestions.push(t('errorTryEnglish'));
                        // Provide some common drug suggestions
                        const commonSuggestions = ['aspirin', 'prednisone', 'piperacillin', 'vancomycin'];
                        suggestions.push(`${t('tryCommonDrugs')}: ${commonSuggestions.join(', ')}`);
                    } else {
                        suggestions.push(t('checkSpelling'));
                        suggestions.push(t('tryPartialName'));
                    }
                    
                    dropdown.innerHTML = `
                        <div class="drug-option" style="color: #999; cursor: default; padding: 15px;">
                            <div style="margin-bottom: 8px;">${helpText}</div>
                            <div style="font-size: 12px; color: #666;">
                                ${suggestions.map(s => `<div style="margin: 4px 0;">‚Ä¢ ${s}</div>`).join('')}
                            </div>
                        </div>
                    `;
                    dropdown.classList.add('show');
                }
            });
            
            // Support Enter key to quickly select first result
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && dropdown.classList.contains('show')) {
                    const firstOption = dropdown.querySelector('.drug-option');
                    if (firstOption && firstOption.onclick) {
                        firstOption.click();
                    }
                }
            });
            
            // Click outside to close dropdown
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });
        }
        
        // Quick add common drug combinations
        function addCommonCombination() {
            const commonDrugs = {
                'Penicillin class': ['piperacillin', 'nafcillin'],
                'Cephalosporin class': ['ceftriaxone', 'cefazolin'],
                'Aspirin + Prednisone': ['aspirin', 'prednisone'],
                'Penicillin + Aspirin + Prednisone': ['piperacillin', 'aspirin', 'prednisone']
            };
            
            // Can add a quick selection button
            console.log('Common combinations:', commonDrugs);
        }
        
        // Select drug
        function selectDrug(drug) {
            if (!selectedDrugs.includes(drug)) {
                selectedDrugs.push(drug);
                updateSelectedDrugs();
            }
            document.getElementById('drugSearch').value = '';
            document.getElementById('drugDropdown').classList.remove('show');
        }
        
        // Update selected drugs display
        function updateSelectedDrugs() {
            const container = document.getElementById('selectedDrugs');
            if (selectedDrugs.length === 0) {
                container.innerHTML = `<div style="color: #999; padding: 10px;">${t('noDrugsSelected')}</div>`;
            } else {
                container.innerHTML = selectedDrugs.map(drug => {
                    // Only show Chinese name in Chinese environment
                    let displayName = drug;
                    if (currentLanguage === 'zh') {
                        const chineseName = getChineseDrugName(drug);
                        displayName = chineseName ? `${drug} (${chineseName})` : drug;
                    }
                    return `<div class="drug-tag">
                        ${displayName}
                        <span class="remove" onclick="removeDrug('${drug}')">√ó</span>
                    </div>`;
                }).join('');
            }
            
            const btn = document.getElementById('analyzeBtn');
            btn.disabled = selectedDrugs.length < 2;
            if (selectedDrugs.length < 2) {
                btn.title = t('selectAtLeast2');
            } else {
                btn.title = `${t('currentSelected')} ${selectedDrugs.length} ${t('drugs')}, ${t('btnAnalyze')}`;
            }
        }
        
        // Remove drug
        function removeDrug(drug) {
            selectedDrugs = selectedDrugs.filter(d => d !== drug);
            updateSelectedDrugs();
        }
        
        // Analyze drug combination
        async function analyzeCombination() {
            if (selectedDrugs.length < 2) {
                alert(`${t('selectAtLeast2')}\n\n${t('currentSelected')}: ${selectedDrugs.length} ${t('drugs')}\n${t('selectedDrugs')}: ${selectedDrugs.join(', ') || t('noDrugsSelected')}`);
                return;
            }
            
            console.log('Starting drug combination analysis:', selectedDrugs);
            
            // Show loading state
            document.getElementById('loading').classList.add('show');
            document.getElementById('results').classList.remove('show');
            document.getElementById('error').style.display = 'none';
            
            try {
                // Build patient data
                const patientData = {};
                selectedDrugs.forEach(drug => {
                    patientData[drug] = 1;
                });
                
                // Add lab indicators (default normal values)
                patientData.bun = 0;
                patientData.inr = 0;
                patientData.lactate = 0;
                patientData.platelets = 0;
                patientData.wbc = 0;
                patientData.albu_lab = 0;
                patientData.o2sat = 0;
                patientData.pao2 = 0;
                patientData.paco2 = 0;
                patientData.ph = 0;
                patientData.bands = 0;
                patientData.hct = 0;
                
                // Call drug combination analysis, organ function prediction, drug recommendation, and side effects simultaneously
                // Use fetch with timeout, but only retry main request
                let combinationResponse, predictResponse, recommendResponse, sideEffectsResponse;
                
                try {
                    [combinationResponse, predictResponse, recommendResponse, sideEffectsResponse] = await Promise.all([
                        fetchWithTimeout(`${API_BASE}/drug_combinations`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(patientData)
                        }, 45000, 1),
                        fetchWithTimeout(`${API_BASE}/predict`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(patientData)
                        }, 30000, 0),
                        fetchWithTimeout(`${API_BASE}/drugs/recommend`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ drugs: selectedDrugs })
                        }, 30000, 0),
                        fetchWithTimeout(`${API_BASE}/drugs/side-effects`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ drugs: selectedDrugs })
                        }, 30000, 0)
                    ]);
                } catch (e) {
                    // If network error or timeout, throw directly
                    console.error('Request sending failed:', e);
                    throw e;
                }
                
                // Check combination analysis response status
                let combinationData;
                if (!combinationResponse || !combinationResponse.ok) {
                    const status = combinationResponse ? combinationResponse.status : 0;
                    let errorData = {};
                    
                    if (combinationResponse) {
                        try {
                            // Try to parse error response
                            const contentType = combinationResponse.headers.get('content-type');
                            console.log('Error response Content-Type:', contentType);
                            console.log('Error response status:', status, combinationResponse.statusText);
                            
                            if (contentType && contentType.includes('application/json')) {
                                errorData = await combinationResponse.json().catch(() => ({}));
                                console.log('Parsed JSON error data:', errorData);
                            } else {
                                const text = await combinationResponse.text().catch(() => '');
                                console.log('Parsed text error data:', text);
                                if (text && text.trim()) {
                                    try {
                                        errorData = JSON.parse(text);
                                        console.log('Text parsed to JSON successfully:', errorData);
                                    } catch {
                                        errorData = { message: text || combinationResponse.statusText || 'Unknown error' };
                                        console.log('Text parsing to JSON failed, using text as message');
                                    }
                                } else {
                                    errorData = { message: combinationResponse.statusText || 'Unknown error' };
                                    console.log('Text is empty, using status text');
                                }
                            }
                        } catch (e) {
                            console.warn('Unable to parse error response:', e);
                            // If parsing fails, try to read text directly
                            try {
                                const text = await combinationResponse.text();
                                errorData = { message: text || combinationResponse.statusText || 'Unknown error' };
                                console.log('Fallback parsing method got error data:', errorData);
                            } catch {
                                errorData = { message: combinationResponse.statusText || 'Unknown error' };
                                console.log('All parsing methods failed, using status text');
                            }
                        }
                    } else {
                        errorData = { message: 'Unable to connect to server' };
                    }
                    
                    if (status === 503) {
                        // 503 Service Unavailable - Data not loaded or service unavailable
                        const errorMsg = errorData.message || errorData.error || t('error503');
                        
                        const solutionMsg = 
                            t('error503Cause') + ':\n' +
                            '1. ' + t('error503Cause1') + '\n' +
                            '2. ' + t('error503Cause2') + '\n' +
                            '3. ' + t('error503Cause3') + '\n\n' +
                            t('error503Solution') + ':\n' +
                            '‚Ä¢ ' + t('error503Solution1') + '\n' +
                            '‚Ä¢ ' + t('error503Solution2') + ': ' + API_BASE + '/health\n' +
                            '‚Ä¢ ' + t('error503Solution3');
                        
                        throw new Error(errorMsg + '\n\n' + solutionMsg);
                    } else {
                        // Other errors
                        const errorText = errorData.error || errorData.message || 
                                         errorData.detail || 
                                         (status ? `HTTP ${status}: ${combinationResponse.statusText}` : 'Network error');
                        throw new Error(errorText);
                    }
                }
                
                combinationData = await combinationResponse.json();
                let predictData = null;
                if (predictResponse) {
                    try {
                        if (predictResponse.ok) {
                            predictData = await predictResponse.json();
                            console.log('Prediction API response:', predictData);
                        } else {
                            // Parse error response
                            let errorData = {};
                            try {
                                const contentType = predictResponse.headers.get('content-type');
                                if (contentType && contentType.includes('application/json')) {
                                    errorData = await predictResponse.json();
                                } else {
                                    const text = await predictResponse.text();
                                    if (text) {
                                        try {
                                            errorData = JSON.parse(text);
                                        } catch {
                                            errorData = { message: text || predictResponse.statusText };
                                        }
                                    }
                                }
                            } catch (e) {
                                console.warn('Unable to parse prediction error response:', e);
                                errorData = { message: predictResponse.statusText || 'Unknown error' };
                            }
                            
                            console.warn('Prediction API returned error:', predictResponse.status, errorData);
                            // Even if prediction fails, continue to show other results
                            const errorMsg = errorData.error || errorData.message || t('errorApiConnection');
                            predictData = { error: errorMsg };
                        }
                    } catch (e) {
                        console.warn('Prediction API call failed:', e);
                        const errorMsg = t('errorApiConnection');
                        predictData = { error: errorMsg };
                    }
                } else {
                    console.warn('Prediction API request failed, predictResponse is null');
                    const errorMsg = t('errorApiConnection');
                    predictData = { error: errorMsg };
                }
                
                let recommendData = null;
                if (recommendResponse) {
                    try {
                        if (recommendResponse.ok) {
                            recommendData = await recommendResponse.json();
                            console.log('Recommendation API response:', recommendData);
                        } else {
                            console.warn('Recommendation API returned error:', recommendResponse.status);
                            // Even if API fails, set empty structure so we can show fallback message
                            recommendData = { success: false, recommendations: [] };
                        }
                    } catch (e) {
                        console.warn('Recommendation API call failed:', e);
                        recommendData = { success: false, recommendations: [] };
                    }
                } else {
                    console.warn('Recommendation API request failed, recommendResponse is null');
                    recommendData = { success: false, recommendations: [] };
                }
                
                let sideEffectsData = null;
                if (sideEffectsResponse) {
                    try {
                        if (sideEffectsResponse.ok) {
                            sideEffectsData = await sideEffectsResponse.json();
                            console.log('Side effects API response:', sideEffectsData);
                        } else {
                            console.warn('Side effects API returned error:', sideEffectsResponse.status);
                            sideEffectsData = { success: false };
                        }
                    } catch (e) {
                        console.warn('Side effects API call failed:', e);
                        sideEffectsData = { success: false };
                    }
                } else {
                    console.warn('Side effects API request failed, sideEffectsResponse is null');
                    sideEffectsData = { success: false };
                }
                
                if (combinationData.success) {
                    displayResults(combinationData.analysis, predictData, recommendData, sideEffectsData);
                } else {
                    const errorMsg = t('errorApiConnection');
                    throw new Error(combinationData.error || errorMsg);
                }
            } catch (error) {
                console.error('Analysis failed:', error);
                
                // Handle different types of errors
                let errorMessage = '';
                
                // Check if it's a network/fetch error
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage = currentLanguage === 'zh' ? 
                        'ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºöÊó†Ê≥ïËøûÊé•Âà∞APIÊúçÂä°\n\nÂèØËÉΩÂéüÂõ†Ôºö\n1. APIÊúçÂä°Êú™ÂêØÂä®ÊàñÂ∑≤ÂÅúÊ≠¢\n2. ÁΩëÁªúËøûÊé•ÈóÆÈ¢ò\n3. CORSË∑®ÂüüÈóÆÈ¢ò\n4. APIÂú∞ÂùÄÈÖçÁΩÆÈîôËØØ' :
                        currentLanguage === 'fr' ?
                        '√âchec de connexion r√©seau : Impossible de se connecter au service API\n\nCauses possibles :\n1. Le service API n\'est pas d√©marr√© ou s\'est arr√™t√©\n2. Probl√®me de connexion r√©seau\n3. Probl√®me CORS\n4. Configuration incorrecte de l\'adresse API' :
                        'Network connection failed: Unable to connect to API service\n\nPossible causes:\n1. API service is not running or has stopped\n2. Network connection issue\n3. CORS cross-origin issue\n4. Incorrect API address configuration';
                    
                    // Try to check API health
                    fetch(`${API_BASE}/health`)
                        .then(response => {
                            if (response.ok) {
                                console.log('Health check successful, API is running');
                            } else {
                                console.warn('Health check failed:', response.status);
                            }
                        })
                        .catch(e => {
                            console.error('Health check also failed:', e);
                            errorMessage += currentLanguage === 'zh' ? 
                                '\n\n‚ö†Ô∏è ÂÅ•Â∫∑Ê£ÄÊü•‰πüÂ§±Ë¥•ÔºåAPIÊúçÂä°ÂèØËÉΩÂ∑≤ÂÅúÊ≠¢„ÄÇËØ∑Ê£ÄÊü•Ôºö\n‚Ä¢ Render Dashboard ‰∏≠ÊúçÂä°Áä∂ÊÄÅ\n‚Ä¢ ÊúçÂä°ÊòØÂê¶Ê≠£Âú®ËøêË°å\n‚Ä¢ ÊòØÂê¶ÈúÄË¶ÅÈáçÊñ∞ÈÉ®ÁΩ≤' :
                                currentLanguage === 'fr' ?
                                '\n\n‚ö†Ô∏è Le contr√¥le de sant√© a √©galement √©chou√©, le service API peut √™tre arr√™t√©. Veuillez v√©rifier :\n‚Ä¢ L\'√©tat du service dans Render Dashboard\n‚Ä¢ Si le service est en cours d\'ex√©cution\n‚Ä¢ S\'il faut red√©ployer' :
                                '\n\n‚ö†Ô∏è Health check also failed, API service may be stopped. Please check:\n‚Ä¢ Service status in Render Dashboard\n‚Ä¢ Whether the service is running\n‚Ä¢ If redeployment is needed';
                        });
                } else {
                    // Other errors
                    errorMessage = error.message || String(error);
                    
                    // If error message doesn't contain keywords like "HTTP" or "503", add prefix
                    if (!errorMessage.includes('HTTP') && !errorMessage.includes('503') && 
                        !errorMessage.includes('Service Unavailable') && 
                        !errorMessage.includes('ÊúçÂä°ÊöÇÊó∂‰∏çÂèØÁî®')) {
                        const errorPrefix = currentLanguage === 'zh' ? 'ÂàÜÊûêÂ§±Ë¥•: ' : 
                                          currentLanguage === 'fr' ? '√âchec de l\'analyse: ' : 
                                          'Analysis failed: ';
                        errorMessage = errorPrefix + errorMessage;
                    }
                }
                
                // Add service status check suggestion
                const checkHealthMsg = currentLanguage === 'zh' ? 
                    '\n\nüí° ÊèêÁ§∫ÔºöÊÇ®ÂèØ‰ª•ËÆøÈóÆ ' + API_BASE + '/health Êü•ÁúãÊúçÂä°Áä∂ÊÄÅ' :
                    currentLanguage === 'fr' ?
                    '\n\nüí° Astuce : Vous pouvez visiter ' + API_BASE + '/health pour v√©rifier l\'√©tat du service' :
                    '\n\nüí° Tip: You can visit ' + API_BASE + '/health to check service status';
                
                errorMessage += checkHealthMsg;
                
                // Add API address info for debugging
                errorMessage += currentLanguage === 'zh' ? 
                    '\n\nÂΩìÂâçAPIÂú∞ÂùÄ: ' + API_BASE :
                    currentLanguage === 'fr' ?
                    '\n\nAdresse API actuelle : ' + API_BASE :
                    '\n\nCurrent API address: ' + API_BASE;
                
                showError(errorMessage);
            } finally {
                document.getElementById('loading').classList.remove('show');
            }
        }
        
        // Display results
        function displayResults(analysis, predictions = null, recommendations = null, sideEffects = null) {
            // Overall risk
            const overallRisk = analysis.overall_risk;
            const riskClass = overallRisk === 'high' ? 'risk-high' : 
                            overallRisk === 'medium' ? 'risk-medium' : 'risk-low';
            const riskText = overallRisk === 'high' ? t('highRisk') : 
                           overallRisk === 'medium' ? t('mediumRisk') : t('lowRisk');
            
            document.getElementById('overallRisk').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="label">${t('overallRiskLevel')}</div>
                        <div class="value"><span class="risk-badge ${riskClass}">${riskText}</span></div>
                    </div>
                    <div class="stat-item">
                        <div class="label">${t('averageRelativeRisk')}</div>
                        <div class="value">${analysis.average_relative_risk.toFixed(2)}</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">${t('maxRelativeRisk')}</div>
                        <div class="value">${analysis.max_relative_risk.toFixed(2)}</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">${t('analyzedCombinations')}</div>
                        <div class="value">${analysis.analyzed_combinations}</div>
                    </div>
                </div>
            `;
            
            // Multi-organ dysfunction prediction tabs
            const organTypes = [
                { id: 'kidney', name: t('kidneyAbnormal'), key: 'kidney_abnormal', desc: currentLanguage === 'zh' ? `${t('basedOn')} BUN ${t('predict')} ${t('kidneyAbnormal')} ${t('risk')}` : `Predict ${t('kidneyAbnormal')} ${t('risk')} based on BUN and other indicators` },
                { id: 'liver', name: t('liverAbnormal'), key: 'liver_abnormal', desc: currentLanguage === 'zh' ? `${t('basedOn')} INR„ÄÅ${t('basedOn')} ${t('predict')} ${t('liverAbnormal')} ${t('risk')}` : `Predict ${t('liverAbnormal')} ${t('risk')} based on INR, albumin and other indicators` },
                { id: 'organ', name: t('organAbnormal'), key: 'organ_abnormal', desc: currentLanguage === 'zh' ? `${t('basedOn')} ${t('predict')} ${t('kidneyAbnormal')} ${t('risk')}` : `Comprehensive prediction of kidney and liver dysfunction ${t('risk')}` }
            ];
            
            let tabsHtml = '';
            let contentHtml = '';
            
            organTypes.forEach((organ, index) => {
                const active = index === 0 ? 'active' : '';
                tabsHtml += `<button class="outcome-tab ${active}" onclick="switchOrgan('${organ.id}')">${organ.name}</button>`;
                
                let organHtml = `<div class="outcome-content ${active}" id="organ-${organ.id}">`;
                
                // Display prediction results
                // Check if there's an error
                if (predictions && predictions.error) {
                    organHtml += `
                        <div class="combination-item" style="background: #fff3cd; border-left: 4px solid #ffc107;">
                            <h4>${organ.name} ${t('predict')}</h4>
                            <p style="color: #856404; margin-bottom: 10px;">
                                ‚ö†Ô∏è ${predictions.error}
                            </p>
                            <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 10px;">
                                <p style="font-size: 12px; color: #666; margin-bottom: 5px;"><strong>${t('solution')}:</strong></p>
                                <ol style="font-size: 12px; color: #666; margin-left: 20px; padding-left: 0;">
                                    <li>${t('checkApiRunning')}</li>
                                    <li>${t('checkApiHealth')}: <a href="http://localhost:5003/health" target="_blank">http://localhost:5003/health</a></li>
                                    <li>${t('restartApi')}: <code>python3 cdss_api.py</code></li>
                                    <li>${t('checkApiLogs')}</li>
                                </ol>
                            </div>
                        </div>
                    `;
                } else if (predictions && predictions.predictions && predictions.predictions[organ.key]) {
                    const pred = predictions.predictions[organ.key];
                    const isAbnormal = pred.prediction === 1;
                    const probability = pred.probability !== null ? (pred.probability * 100).toFixed(2) : 'N/A';
                    const riskLevel = pred.probability > 0.5 ? t('highRisk') : pred.probability > 0.3 ? t('mediumRisk') : t('lowRisk');
                    const riskClass = pred.probability > 0.5 ? 'risk-high' : pred.probability > 0.3 ? 'risk-medium' : 'risk-low';
                    
                    organHtml += `
                        <div class="combination-item" style="background: ${isAbnormal ? '#fee' : '#efe'}; border-left: 4px solid ${isAbnormal ? '#dc3545' : '#28a745'};">
                            <h4>${organ.name} ${t('predictionResult')}</h4>
                            <p style="color: #666; font-size: 12px; margin-bottom: 15px;">${organ.desc}</p>
                            <div style="margin: 15px 0;">
                                <p><strong>${t('predictionStatus')}:</strong> 
                                    <span class="risk-badge ${riskClass}" style="font-size: 14px; margin-left: 10px;">
                                        ${isAbnormal ? `‚ö†Ô∏è ${t('abnormal')}` : `‚úÖ ${t('normal')}`}
                                    </span>
                                </p>
                                <p><strong>${t('abnormalProbability')}:</strong> <span style="font-size: 18px; font-weight: bold; color: ${isAbnormal ? '#c33' : '#155724'};">${probability}%</span></p>
                                <p><strong>${t('riskLevel')}:</strong> ${riskLevel}</p>
                            </div>
                            ${isAbnormal ? 
                                `<p style="color: #c33; font-weight: bold; padding: 10px; background: #fff3cd; border-radius: 5px;">‚ö†Ô∏è ${t('suggestMonitor')}</p>` : 
                                `<p style="color: #155724; padding: 10px; background: #d4edda; border-radius: 5px;">‚úÖ ${t('predictionNormal')}</p>`}
                        </div>
                    `;
                } else {
                    // Check if it's an API error
                    const hasError = predictions && predictions.error;
                    const errorMsg = hasError ? predictions.error : t('modelNotLoaded');
                    
                    organHtml += `
                        <div class="combination-item" style="background: #fff3cd; border-left: 4px solid #ffc107;">
                            <h4>${organ.name} ${t('predict')}</h4>
                            <p style="color: #856404; margin-bottom: 10px;">
                                ‚ö†Ô∏è ${errorMsg}
                            </p>
                            <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 10px;">
                                <p style="font-size: 12px; color: #666; margin-bottom: 5px;"><strong>${t('solution')}:</strong></p>
                                <ol style="font-size: 12px; color: #666; margin-left: 20px; padding-left: 0;">
                                    <li>${t('checkApiRunning')}</li>
                                    <li>${t('checkApiHealth')}: <a href="http://localhost:5003/health" target="_blank">http://localhost:5003/health</a></li>
                                    <li>${t('restartApi')}: <code>python3 cdss_api.py</code></li>
                                    <li>${t('checkApiLogs')}</li>
                                </ol>
                            </div>
                        </div>
                    `;
                }
                
                // Display related drug combination analysis
                const risky = analysis.risky_combinations || [];
                const effective = analysis.effective_combinations || [];
                
                if (risky.length > 0) {
                    organHtml += `<h4 style="color: #c33; margin-top: 20px;">‚ö†Ô∏è ${t('riskyCombinations')}</h4>`;
                    risky.forEach(combo => {
                        organHtml += `
                            <div class="combination-item">
                                <h4>${combo.drug1} + ${combo.drug2}</h4>
                                <p><strong>${t('relativeRisk')}:</strong> ${combo.relative_risk.toFixed(2)}</p>
                                <p>${translateInterpretation(combo.interpretation || '')}</p>
                            </div>
                        `;
                    });
                }
                
                if (effective.length > 0) {
                    organHtml += `<h4 style="color: #155724; margin-top: 20px;">‚úÖ ${t('effectiveCombinations')}</h4>`;
                    effective.forEach(combo => {
                        organHtml += `
                            <div class="combination-item">
                                <h4>${combo.drug1} + ${combo.drug2}</h4>
                                <p><strong>${t('relativeRisk')}:</strong> ${combo.relative_risk.toFixed(2)}</p>
                                <p>${translateInterpretation(combo.interpretation || '')}</p>
                            </div>
                        `;
                    });
                }
                
                if (risky.length === 0 && effective.length === 0 && (!predictions || !predictions.predictions)) {
                    organHtml += `<p style="color: #666; padding: 20px;">${t('noData')}</p>`;
                }
                
                organHtml += '</div>';
                contentHtml += organHtml;
            });
            
            document.getElementById('outcomeTabs').innerHTML = tabsHtml;
            document.getElementById('outcomeContent').innerHTML = contentHtml;
            
            // Recommendations and recommended drugs
            let recommendationsHtml = '';
            
            // Display drug side effects information
            if (sideEffects && sideEffects.success && sideEffects.drugs) {
                recommendationsHtml += `
                    <h4 style="margin-top: 20px; color: #856404;">‚ö†Ô∏è ${currentLanguage === 'zh' ? 'ËçØÁâ©ÊØíÂâØ‰ΩúÁî®ÊèêÁ§∫' : currentLanguage === 'fr' ? 'Avertissements sur les Effets Secondaires des M√©dicaments' : 'Drug Side Effects & Toxicity Warnings'}</h4>
                    <div style="display: grid; gap: 15px; margin-bottom: 20px;">
                `;
                
                for (const [drugName, drugInfo] of Object.entries(sideEffects.drugs)) {
                    if (drugInfo.side_effects && drugInfo.side_effects.length > 0) {
                        const toxicityLevels = drugInfo.organ_toxicity || {};
                        const hasHighToxicity = Object.values(toxicityLevels).some(level => level === 'high');
                        const bgColor = hasHighToxicity ? '#fee' : '#fff3cd';
                        const borderColor = hasHighToxicity ? '#dc3545' : '#ffc107';
                        
                        recommendationsHtml += `
                            <div class="combination-item" style="background: ${bgColor}; border-left: 4px solid ${borderColor};">
                                <h4 style="color: ${hasHighToxicity ? '#c33' : '#856404'}; margin-bottom: 10px;">
                                    üíä ${drugName}
                                    ${hasHighToxicity ? '<span style="font-size: 12px; color: #c33; margin-left: 10px;">‚ö†Ô∏è High Toxicity Risk</span>' : ''}
                                </h4>
                                
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: ${hasHighToxicity ? '#c33' : '#856404'};">${currentLanguage === 'zh' ? '‰∏ªË¶ÅÊØíÂâØ‰ΩúÁî®' : currentLanguage === 'fr' ? 'Effets Secondaires Principaux' : 'Main Side Effects'}:</strong>
                                    <ul style="margin: 5px 0 0 20px; color: #666;">
                                        ${drugInfo.side_effects.map(effect => `<li>${effect}</li>`).join('')}
                                    </ul>
                                </div>
                                
                                ${Object.keys(toxicityLevels).length > 0 ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: ${hasHighToxicity ? '#c33' : '#856404'};">${currentLanguage === 'zh' ? 'Âô®ÂÆòÊØíÊÄß' : currentLanguage === 'fr' ? 'Toxicit√© Organique' : 'Organ Toxicity'}:</strong>
                                        <div style="margin-top: 5px;">
                                            ${Object.entries(toxicityLevels).map(([organ, level]) => {
                                                const levelColors = {
                                                    'high': '#c33',
                                                    'medium': '#ff9800',
                                                    'low': '#4caf50'
                                                };
                                                const levelText = {
                                                    'high': currentLanguage === 'zh' ? 'È´ò' : currentLanguage === 'fr' ? '√âlev√©' : 'High',
                                                    'medium': currentLanguage === 'zh' ? '‰∏≠' : currentLanguage === 'fr' ? 'Moyen' : 'Medium',
                                                    'low': currentLanguage === 'zh' ? '‰Ωé' : currentLanguage === 'fr' ? 'Faible' : 'Low'
                                                };
                                                return `<span style="display: inline-block; margin: 2px 5px; padding: 2px 8px; background: ${levelColors[level] || '#999'}; color: white; border-radius: 3px; font-size: 11px;">${organ}: ${levelText[level] || level}</span>`;
                                            }).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${drugInfo.monitoring && drugInfo.monitoring.length > 0 ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: ${hasHighToxicity ? '#c33' : '#856404'};">${currentLanguage === 'zh' ? 'ÁõëÊµãÂª∫ËÆÆ' : currentLanguage === 'fr' ? 'Recommandations de Surveillance' : 'Monitoring Recommendations'}:</strong>
                                        <ul style="margin: 5px 0 0 20px; color: #666; font-size: 12px;">
                                            ${drugInfo.monitoring.map(item => `<li>${item}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                
                                ${drugInfo.contraindications && drugInfo.contraindications.length > 0 ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #c33;">${currentLanguage === 'zh' ? 'Á¶ÅÂøåÁóá' : currentLanguage === 'fr' ? 'Contre-indications' : 'Contraindications'}:</strong>
                                        <ul style="margin: 5px 0 0 20px; color: #c33; font-size: 12px;">
                                            ${drugInfo.contraindications.map(item => `<li>${item}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                
                                ${drugInfo.precautions ? `
                                    <div style="margin-top: 10px; padding: 8px; background: #f0f0f0; border-radius: 5px; font-size: 12px; color: #666;">
                                        <strong>${currentLanguage === 'zh' ? 'Ê≥®ÊÑè‰∫ãÈ°π' : currentLanguage === 'fr' ? 'Pr√©cautions' : 'Precautions'}:</strong> ${drugInfo.precautions}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                }
                
                recommendationsHtml += `</div>`;
            }
            
            // Display clinical recommendations
            if (analysis.recommendations && analysis.recommendations.length > 0) {
                recommendationsHtml += `
                    <h4>üí° ${t('clinicalRecommendations')}</h4>
                    <ul>
                        ${analysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                `;
            }
            
            // Display recommended drugs (if high or medium risk is predicted)
            const hasHighRisk = predictions && predictions.predictions && 
                Object.values(predictions.predictions).some(p => 
                    p.prediction === 1 || (p.probability && p.probability > 0.2)
                );
            
            // Or if drug combination analysis shows high risk
            const hasCombinationRisk = analysis.overall_risk === 'high' || analysis.overall_risk === 'medium';
            
            // Check for low risk (for preventive recommendations)
            const hasLowRisk = analysis.overall_risk === 'low' || 
                              (predictions && predictions.predictions && 
                               Object.values(predictions.predictions).every(p => 
                                   p.prediction === 0 && (!p.probability || p.probability <= 0.2)
                               ));
            
            // Show recommendations if there's risk AND (we have recommendations OR we should show known protective drugs)
            const hasRecommendations = recommendations && recommendations.success && 
                                     recommendations.recommendations && 
                                     recommendations.recommendations.length > 0;
            
            // Show recommendations for high/medium risk, or preventive recommendations for low risk
            const shouldShowRecommendations = ((hasHighRisk || hasCombinationRisk) && hasRecommendations) ||
                                             (hasLowRisk && hasRecommendations);
            
            if (shouldShowRecommendations) {
                recommendationsHtml += `
                    <h4 style="margin-top: 20px; color: #0c5460;">üíä ${t('preventOrganDysfunction')}</h4>
                    <p style="color: #666; font-size: 12px; margin-bottom: 15px;">
                        ${t('basedOnAnalysis')}:
                    </p>
                    ${hasHighRisk ? `<p style="color: #c33; font-size: 12px; margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 5px;">‚ö†Ô∏è ${t('detectedRisk')}</p>` : ''}
                    <div style="display: grid; gap: 10px;">
                        ${recommendations.recommendations.map(rec => `
                            <div class="combination-item" style="background: #d1ecf1; border-left: 4px solid #0c5460;">
                                <h4 style="color: #0c5460; margin-bottom: 8px;">
                                    ${rec.drug}
                                    ${rec.best_combo_with ? `<span style="font-size: 12px; color: #666;">(${currentLanguage === 'zh' ? `${t('comboWith')} ${rec.best_combo_with} ${t('comboWithSuffix')}` : currentLanguage === 'fr' ? `${t('comboWith')} ${rec.best_combo_with} ${t('comboWithSuffix')}` : `${t('comboWith')} ${rec.best_combo_with} ${t('comboWithSuffix')}`})</span>` : ''}
                                </h4>
                                <p style="color: #0c5460; margin: 5px 0;">
                                    <strong>${t('recommendedReason')}:</strong> ${rec.reason || rec.potential_benefit || (currentLanguage === 'zh' ? 'ÂèØËÉΩÈôç‰ΩéÂô®ÂÆòÂäüËÉΩÂºÇÂ∏∏È£éÈô©' : currentLanguage === 'fr' ? 'Peut r√©duire le risque de dysfonctionnement d\'organe' : 'May reduce organ dysfunction risk')}
                                </p>
                                ${rec.risk_reduction > 0 ? `
                                    <p style="color: #0c5460; font-size: 12px; margin-top: 5px;">
                                        ${t('potentialRiskReduction')}: ${(rec.risk_reduction * 100).toFixed(1)}%
                                    </p>
                                ` : ''}
                                <button onclick="addRecommendedDrug('${rec.drug}')" 
                                        style="margin-top: 10px; padding: 6px 15px; background: #0c5460; color: white; 
                                               border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                    ‚ûï ${t('addThisDrug')}
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    <p style="color: #999; font-size: 11px; margin-top: 15px;">
                        ${t('noteRecommendations')}
                    </p>
                `;
            } else if (hasHighRisk || hasCombinationRisk) {
                recommendationsHtml += `
                    <h4 style="margin-top: 20px; color: #856404;">üíä ${t('drugRecommendation')}</h4>
                    <p style="color: #666;">${t('noRecommendationData')}</p>
                    <p style="color: #999; font-size: 11px; margin-top: 10px;">
                        ${t('suggestionAntioxidant')}
                    </p>
                `;
            } else if (hasLowRisk && hasRecommendations) {
                // Show preventive recommendations for low risk cases
                recommendationsHtml += `
                    <h4 style="margin-top: 20px; color: #155724;">üíä ${t('preventOrganDysfunction')}</h4>
                    <p style="color: #666; font-size: 12px; margin-bottom: 15px;">
                        ${currentLanguage === 'zh' ? 'ÂΩìÂâçÈ£éÈô©ËæÉ‰ΩéÔºå‰ª•‰∏ã‰øùÊä§ÊÄßËçØÁâ©ÂèØ‰Ωú‰∏∫È¢ÑÈò≤ÊÄß‰ΩøÁî®ÔºåÂ∏ÆÂä©Áª¥ÊåÅÂô®ÂÆòÂäüËÉΩÂÅ•Â∫∑' : 
                          currentLanguage === 'fr' ? 'Le risque actuel est faible, les m√©dicaments protecteurs suivants peuvent √™tre utilis√©s de mani√®re pr√©ventive pour aider √† maintenir la sant√© des organes' :
                          'Current risk is low, the following protective drugs can be used preventively to help maintain organ health'}:
                    </p>
                    <div style="display: grid; gap: 10px;">
                        ${recommendations.recommendations.map(rec => `
                            <div class="combination-item" style="background: #d4edda; border-left: 4px solid #28a745;">
                                <h4 style="color: #155724; margin-bottom: 8px;">
                                    ${rec.drug}
                                    ${rec.best_combo_with ? `<span style="font-size: 12px; color: #666;">(${currentLanguage === 'zh' ? `${t('comboWith')} ${rec.best_combo_with} ${t('comboWithSuffix')}` : currentLanguage === 'fr' ? `${t('comboWith')} ${rec.best_combo_with} ${t('comboWithSuffix')}` : `${t('comboWith')} ${rec.best_combo_with} ${t('comboWithSuffix')}`})</span>` : ''}
                                </h4>
                                <p style="color: #155724; margin: 5px 0;">
                                    <strong>${t('recommendedReason')}:</strong> ${rec.reason || rec.potential_benefit || (currentLanguage === 'zh' ? 'ÂèØËÉΩÊúâÂä©‰∫éÁª¥ÊåÅÂô®ÂÆòÂäüËÉΩÂÅ•Â∫∑' : currentLanguage === 'fr' ? 'Peut aider √† maintenir la sant√© des organes' : 'May help maintain organ health')}
                                </p>
                                ${rec.risk_reduction > 0 ? `
                                    <p style="color: #155724; font-size: 12px; margin-top: 5px;">
                                        ${t('potentialRiskReduction')}: ${(rec.risk_reduction * 100).toFixed(1)}%
                                    </p>
                                ` : ''}
                                <button onclick="addRecommendedDrug('${rec.drug}')" 
                                        style="margin-top: 10px; padding: 6px 15px; background: #28a745; color: white; 
                                               border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                    ‚ûï ${t('addThisDrug')}
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    <p style="color: #999; font-size: 11px; margin-top: 15px;">
                        ${t('noteRecommendations')}
                    </p>
                `;
            }
            
            if (recommendationsHtml) {
                document.getElementById('recommendations').innerHTML = recommendationsHtml;
            }
            
            // Display results
            document.getElementById('results').classList.add('show');
        }
        
        // Add recommended drug
        function addRecommendedDrug(drug) {
            if (!selectedDrugs.includes(drug)) {
                selectedDrugs.push(drug);
                updateSelectedDrugs();
                // Scroll to selected drugs area
                document.getElementById('selectedDrugs').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                alert(t('drugAlreadySelected'));
            }
        }
        
        // Switch organ type
        function switchOrgan(organId) {
            currentOrgan = organId;
            
            // Update tabs
            document.querySelectorAll('.outcome-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update content
            document.querySelectorAll('.outcome-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`organ-${organId}`).classList.add('active');
        }
        
        // Display error
        function showError(message) {
            const errorDiv = document.getElementById('error');
            // Support multi-line error messages (preserve line breaks)
            errorDiv.innerHTML = message.split('\n').map(line => {
                // If empty line, return <br>
                if (!line.trim()) return '<br>';
                // If title line (contains colon), display in bold
                if (line.includes('Ôºö') || line.includes(':')) {
                    const parts = line.split(/[Ôºö:]/);
                    if (parts.length >= 2) {
                        return `<strong>${parts[0]}:</strong>${parts.slice(1).join(':')}`;
                    }
                }
                // If list item (starts with ‚Ä¢ or number), add appropriate style
                if (line.trim().match(/^[‚Ä¢\d\.]/)) {
                    return `<div style="margin: 4px 0; padding-left: 10px;">${line}</div>`;
                }
                return line;
            }).join('<br>');
            errorDiv.style.display = 'block';
            // Scroll to error message
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        </script>
    </body>
</html>

