<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯ç‰©ç»„åˆåˆ†æç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        /* è¯­è¨€åˆ‡æ¢å™¨ */
        .language-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }
        
        .lang-btn {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }
        
        .lang-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .lang-btn.active {
            background: rgba(255, 255, 255, 0.4);
            border-color: white;
            font-weight: bold;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .drug-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .drug-input-group {
            flex: 1;
            min-width: 300px;
        }
        
        .drug-input-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        .drug-search {
            position: relative;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px 40px 12px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        
        .drug-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .drug-dropdown.show {
            display: block;
        }
        
        .drug-option {
            padding: 12px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .drug-option:hover {
            background: #f0f4ff;
        }
        
        .drug-option:last-child {
            border-bottom: none;
        }
        
        .selected-drugs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .drug-tag {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: #667eea;
            color: white;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .drug-tag .remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
            line-height: 1;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        
        .drug-tag .remove:hover {
            opacity: 1;
        }
        
        .btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 20px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results {
            display: none;
        }
        
        .results.show {
            display: block;
        }
        
        .result-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .result-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .risk-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 10px;
        }
        
        .risk-high {
            background: #fee;
            color: #c33;
        }
        
        .risk-medium {
            background: #fff3cd;
            color: #856404;
        }
        
        .risk-low {
            background: #d4edda;
            color: #155724;
        }
        
        .risk-protective {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .combination-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }
        
        .combination-item h4 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-item {
            padding: 15px;
            background: white;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-item .label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .stat-item .value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .recommendations {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .recommendations h4 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .recommendations ul {
            margin-left: 20px;
            color: #856404;
        }
        
        .recommendations li {
            margin-bottom: 8px;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #dc3545;
        }
        
        .outcome-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        .outcome-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .outcome-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }
        
        .outcome-content {
            display: none;
        }
        
        .outcome-content.active {
            display: block;
        }
    </style>
    <!-- APIé…ç½®è„šæœ¬ - å¿…é¡»åœ¨å…¶ä»–è„šæœ¬ä¹‹å‰åŠ è½½ -->
    <script src="config.js"></script>
</head>
<body>
    <div class="container">
        <div class="header" style="position: relative;">
            <div class="language-switcher">
                <button class="lang-btn active" onclick="switchLanguage('zh')" data-lang="zh">ä¸­æ–‡</button>
                <button class="lang-btn" onclick="switchLanguage('en')" data-lang="en">English</button>
                <button class="lang-btn" onclick="switchLanguage('fr')" data-lang="fr">FranÃ§ais</button>
            </div>
            <h1 id="title">ğŸ’Š è¯ç‰©ç»„åˆåˆ†æç³»ç»Ÿ</h1>
            <p id="subtitle">åˆ†æä»»æ„è¯ç‰©ç»„åˆçš„é£é™©å’Œç–—æ•ˆ</p>
        </div>
        
        <div class="content">
            <!-- è¯ç‰©é€‰æ‹©åŒºåŸŸ -->
            <div class="section">
                <h2 id="section1Title">1. é€‰æ‹©è¯ç‰©</h2>
                <div class="drug-selector">
                    <div class="drug-input-group">
                        <label id="drugSearchLabel">æœç´¢å¹¶æ·»åŠ è¯ç‰©ï¼ˆæ”¯æŒä¸­æ–‡å’Œè‹±æ–‡ï¼‰</label>
                        <div class="drug-search">
                            <input type="text" id="drugSearch" data-placeholder-key="drugSearchPlaceholder">
                            <span class="search-icon">ğŸ”</span>
                            <div class="drug-dropdown" id="drugDropdown"></div>
                        </div>
                        <div style="margin-top: 10px; font-size: 12px; color: #666;" id="drugSearchHint">
                            ğŸ’¡ æç¤ºï¼šæ”¯æŒä¸­æ–‡æœç´¢ï¼ˆå¦‚ï¼šé’éœ‰ç´ ã€é˜¿å¸åŒ¹æ—ã€é†‹é…¸æ³¼å°¼æ¾ï¼‰ï¼Œä¹Ÿå¯ä»¥è¾“å…¥è‹±æ–‡åç§°
                        </div>
                    </div>
                </div>
                <div class="selected-drugs" id="selectedDrugs"></div>
                <button class="btn" id="analyzeBtn" onclick="analyzeCombination()" data-text-key="btnAnalyze">å¼€å§‹åˆ†æ</button>
            </div>
            
            <!-- åŠ è½½çŠ¶æ€ -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p id="loadingText">æ­£åœ¨åˆ†æè¯ç‰©ç»„åˆï¼Œè¯·ç¨å€™...</p>
            </div>
            
            <!-- ç»“æœåŒºåŸŸ -->
            <div class="results" id="results">
                <div class="section">
                    <h2 id="resultsTitle">åˆ†æç»“æœ</h2>
                    
                    <!-- æ€»ä½“é£é™© -->
                    <div class="result-card">
                        <h3 id="overallRiskTitle">æ€»ä½“é£é™©è¯„ä¼°</h3>
                        <div id="overallRisk"></div>
                    </div>
                    
                    <!-- å¤šå™¨å®˜åŠŸèƒ½éšœç¢é¢„æµ‹ -->
                    <div class="result-card">
                        <h3 id="organPredictionTitle">å¤šå™¨å®˜åŠŸèƒ½éšœç¢é¢„æµ‹</h3>
                        <div class="outcome-tabs" id="outcomeTabs"></div>
                        <div id="outcomeContent"></div>
                    </div>
                    
                    <!-- å»ºè®® -->
                    <div class="recommendations" id="recommendations"></div>
                </div>
            </div>
            
            <!-- é”™è¯¯ä¿¡æ¯ -->
            <div class="error" id="error" style="display: none;"></div>
        </div>
    </div>
    
    <script>
        // æ”¯æŒé€šè¿‡URLå‚æ•°æˆ–config.jsé…ç½®APIåœ°å€
        // ä¼˜å…ˆçº§ï¼šURLå‚æ•° > config.jsä¸­çš„window.API_BASE_URL > é»˜è®¤localhost
        const urlParams = new URLSearchParams(window.location.search);
        const API_BASE = urlParams.get('api') || 
                        (typeof window.API_BASE_URL !== 'undefined' ? window.API_BASE_URL : 'http://localhost:5003');
        let allDrugs = [];
        let selectedDrugs = [];
        let currentOrgan = 'kidney'; // å½“å‰é€‰æ‹©çš„å™¨å®˜ç±»å‹
        let currentLanguage = localStorage.getItem('language') || 'zh'; // å½“å‰è¯­è¨€
        
        // å›½é™…åŒ–æ–‡æœ¬èµ„æº
        const i18n = {
            zh: {
                title: 'ğŸ’Š è¯ç‰©ç»„åˆåˆ†æç³»ç»Ÿ',
                subtitle: 'åˆ†æä»»æ„è¯ç‰©ç»„åˆçš„é£é™©å’Œç–—æ•ˆ',
                section1Title: '1. é€‰æ‹©è¯ç‰©',
                drugSearchLabel: 'æœç´¢å¹¶æ·»åŠ è¯ç‰©ï¼ˆæ”¯æŒä¸­æ–‡å’Œè‹±æ–‡ï¼‰',
                drugSearchPlaceholder: 'è¾“å…¥è¯ç‰©åç§°æœç´¢ï¼ˆå¦‚ï¼šé’éœ‰ç´ ã€aspirinã€prednisoneï¼‰...',
                drugSearchHint: 'ğŸ’¡ æç¤ºï¼šæ”¯æŒä¸­æ–‡æœç´¢ï¼ˆå¦‚ï¼šé’éœ‰ç´ ã€é˜¿å¸åŒ¹æ—ã€é†‹é…¸æ³¼å°¼æ¾ï¼‰ï¼Œä¹Ÿå¯ä»¥è¾“å…¥è‹±æ–‡åç§°',
                btnAnalyze: 'å¼€å§‹åˆ†æ',
                loadingText: 'æ­£åœ¨åˆ†æè¯ç‰©ç»„åˆï¼Œè¯·ç¨å€™...',
                resultsTitle: 'åˆ†æç»“æœ',
                overallRiskTitle: 'æ€»ä½“é£é™©è¯„ä¼°',
                organPredictionTitle: 'å¤šå™¨å®˜åŠŸèƒ½éšœç¢é¢„æµ‹',
                kidneyAbnormal: 'è‚¾åŠŸèƒ½å¼‚å¸¸',
                liverAbnormal: 'è‚åŠŸèƒ½å¼‚å¸¸',
                organAbnormal: 'å¤šå™¨å®˜åŠŸèƒ½éšœç¢',
                noDrugsSelected: 'æš‚æ— å·²é€‰è¯ç‰©',
                selectAtLeast2: 'è¯·è‡³å°‘é€‰æ‹©2ç§è¯ç‰©',
                currentSelected: 'å½“å‰å·²é€‰æ‹©',
                drugs: 'ç§è¯ç‰©',
                selectedDrugs: 'å·²é€‰è¯ç‰©',
                analyzing: 'åˆ†æä¸­...',
                errorApiConnection: 'æ— æ³•è¿æ¥åˆ°APIæœåŠ¡ï¼Œè¯·ç¡®ä¿APIæœåŠ¡æ­£åœ¨è¿è¡Œ',
                errorApiTimeout: 'APIæœåŠ¡å“åº”è¶…æ—¶ï¼Œå…è´¹ç‰ˆæœåŠ¡å¯èƒ½éœ€è¦30ç§’å¯åŠ¨ï¼Œè¯·ç¨åé‡è¯•',
                serviceStarting: 'æœåŠ¡æ­£åœ¨å¯åŠ¨ä¸­ï¼Œè¯·ç¨å€™...ï¼ˆé¦–æ¬¡è®¿é—®å¯èƒ½éœ€è¦30ç§’ï¼‰',
                errorNoDrugs: 'æœªæ‰¾åˆ°åŒ¹é…çš„è¯ç‰©',
                errorTryEnglish: 'è¯·å°è¯•è¾“å…¥è‹±æ–‡åç§°',
                predictionResult: 'é¢„æµ‹ç»“æœ',
                predictionStatus: 'é¢„æµ‹çŠ¶æ€',
                abnormalProbability: 'å¼‚å¸¸æ¦‚ç‡',
                riskLevel: 'é£é™©ç­‰çº§',
                highRisk: 'é«˜é£é™©',
                mediumRisk: 'ä¸­ç­‰é£é™©',
                lowRisk: 'ä½é£é™©',
                normal: 'æ­£å¸¸',
                abnormal: 'å¼‚å¸¸',
                recommendations: 'ä¸´åºŠå»ºè®®',
                addDrug: 'æ·»åŠ æ­¤è¯ç‰©',
                basedOn: 'åŸºäº',
                predict: 'é¢„æµ‹',
                risk: 'é£é™©',
                noResults: 'æœªå‘ç°æ˜æ˜¾çš„ä¿æŠ¤æ€§è”ç”¨æ•ˆæœ',
                overallRiskLevel: 'æ€»ä½“é£é™©ç­‰çº§',
                averageRelativeRisk: 'å¹³å‡ç›¸å¯¹é£é™©',
                maxRelativeRisk: 'æœ€å¤§ç›¸å¯¹é£é™©',
                analyzedCombinations: 'åˆ†æç»„åˆæ•°',
                predictionResult: 'é¢„æµ‹ç»“æœ',
                suggestMonitor: 'é¢„æµ‹å¯èƒ½å‡ºç°å™¨å®˜åŠŸèƒ½å¼‚å¸¸ï¼Œå»ºè®®å¯†åˆ‡ç›‘æµ‹ç›¸å…³æŒ‡æ ‡ï¼ˆBUNã€INRã€ç™½è›‹ç™½ç­‰ï¼‰',
                predictionNormal: 'å½“å‰é¢„æµ‹ä¸ºæ­£å¸¸ï¼Œç»§ç»­ç›‘æµ‹',
                solution: 'è§£å†³æ–¹æ¡ˆ',
                checkApiRunning: 'æ£€æŸ¥APIæœåŠ¡æ˜¯å¦æ­£åœ¨è¿è¡Œ',
                checkApiHealth: 'è®¿é—®å¥åº·æ£€æŸ¥ç«¯ç‚¹æŸ¥çœ‹æœåŠ¡çŠ¶æ€',
                restartApi: 'å¦‚æœæ¨¡å‹æœªåŠ è½½ï¼Œé‡å¯APIæœåŠ¡',
                checkApiLogs: 'æŸ¥çœ‹APIå¯åŠ¨æ—¥å¿—ï¼Œç¡®è®¤æ¨¡å‹åŠ è½½æˆåŠŸ',
                modelNotLoaded: 'é¢„æµ‹æ¨¡å‹æœªåŠ è½½',
                drugAlreadySelected: 'è¯¥è¯ç‰©å·²åœ¨é€‰æ‹©åˆ—è¡¨ä¸­',
                foundChineseButNoEnglish: 'æ‰¾åˆ°ä¸­æ–‡åç§°ï¼Œä½†æœªåœ¨è¯ç‰©åˆ—è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„è‹±æ–‡è¯ç‰©',
                suggestTryEnglish: 'å»ºè®®ï¼šå°è¯•è¾“å…¥è‹±æ–‡åç§°',
                noMatchingDrugs: 'æœªæ‰¾åˆ°åŒ¹é…çš„è¯ç‰©',
                chineseNotInMap: 'è¯¥ä¸­æ–‡åç§°å¯èƒ½ä¸åœ¨æ˜ å°„è¡¨ä¸­',
                tryCommonDrugs: 'æˆ–å°è¯•å¸¸è§è¯ç‰©',
                checkSpelling: 'è¯·æ£€æŸ¥æ‹¼å†™æ˜¯å¦æ­£ç¡®',
                tryPartialName: 'æˆ–å°è¯•è¾“å…¥éƒ¨åˆ†åç§°',
                preventOrganDysfunction: 'é˜²æ­¢å¤šå™¨å®˜åŠŸèƒ½éšœç¢çš„æ¨èè¯ç‰©',
                basedOnAnalysis: 'åŸºäºæ•°æ®åˆ†æå’Œä¸´åºŠçŸ¥è¯†ï¼Œä»¥ä¸‹è¯ç‰©å¯èƒ½æœ‰åŠ©äºé™ä½å™¨å®˜åŠŸèƒ½å¼‚å¸¸é£é™©',
                detectedRisk: 'æ£€æµ‹åˆ°å™¨å®˜åŠŸèƒ½å¼‚å¸¸é£é™©ï¼Œå»ºè®®è€ƒè™‘æ·»åŠ ä¿æŠ¤æ€§è¯ç‰©',
                recommendedReason: 'æ¨èç†ç”±',
                riskReduction: 'ä¼°è®¡é£é™©é™ä½',
                addThisDrug: 'æ·»åŠ æ­¤è¯ç‰©',
                noteRecommendations: 'âš ï¸ æ³¨æ„ï¼šæ¨èè¯ç‰©ä»…ä¾›å‚è€ƒï¼Œå®é™…ç”¨è¯éœ€ç»“åˆä¸´åºŠåˆ¤æ–­å’Œæ‚£è€…å…·ä½“æƒ…å†µ',
                clinicalRecommendations: 'ä¸´åºŠå»ºè®®',
                noData: 'æš‚æ— ç›¸å…³æ•°æ®',
                riskyCombinations: 'é«˜é£é™©è¯ç‰©ç»„åˆ',
                effectiveCombinations: 'æœ‰æ•ˆè¯ç‰©ç»„åˆ',
                relativeRisk: 'ç›¸å¯¹é£é™©',
                comboWith: 'ä¸',
                comboWithSuffix: 'è”ç”¨',
                potentialRiskReduction: 'æ½œåœ¨é£é™©é™ä½',
                drugRecommendation: 'è¯ç‰©æ¨è',
                noRecommendationData: 'æ£€æµ‹åˆ°å™¨å®˜åŠŸèƒ½å¼‚å¸¸é£é™©ï¼Œä½†æš‚æ— æ¨èè¯ç‰©æ•°æ®',
                suggestionAntioxidant: 'å»ºè®®ï¼šè€ƒè™‘ä½¿ç”¨æŠ—æ°§åŒ–å‰‚ï¼ˆå¦‚N-ä¹™é…°åŠèƒ±æ°¨é…¸ï¼‰ã€ç»´ç”Ÿç´ ç±»ã€æˆ–æ ¹æ®ä¸´åºŠæŒ‡å—ä½¿ç”¨å™¨å®˜ä¿æŠ¤æ€§è¯ç‰©'
            },
            en: {
                title: 'ğŸ’Š Drug Combination Analysis System',
                subtitle: 'Analyze risks and efficacy of any drug combination',
                section1Title: '1. Select Drugs',
                drugSearchLabel: 'Search and add drugs (supports Chinese and English)',
                drugSearchPlaceholder: 'Enter drug name to search (e.g., penicillin, aspirin, prednisone)...',
                drugSearchHint: 'ğŸ’¡ Tip: Supports Chinese or English search (e.g., penicillin, aspirin, prednisone)',
                btnAnalyze: 'Start Analysis',
                loadingText: 'Analyzing drug combination, please wait...',
                resultsTitle: 'Analysis Results',
                overallRiskTitle: 'Overall Risk Assessment',
                organPredictionTitle: 'Multi-Organ Dysfunction Prediction',
                kidneyAbnormal: 'Kidney Dysfunction',
                liverAbnormal: 'Liver Dysfunction',
                organAbnormal: 'Multi-Organ Dysfunction',
                noDrugsSelected: 'No drugs selected',
                selectAtLeast2: 'Please select at least 2 drugs',
                currentSelected: 'Currently selected',
                drugs: 'drugs',
                selectedDrugs: 'Selected drugs',
                analyzing: 'Analyzing...',
                errorApiConnection: 'Cannot connect to API service, please ensure the API service is running',
                errorApiTimeout: 'API service timeout, free tier service may need 30 seconds to start, please retry later',
                serviceStarting: 'Service is starting, please wait... (First access may take 30 seconds)',
                errorNoDrugs: 'No matching drugs found',
                errorTryEnglish: 'Please try entering English names',
                predictionResult: 'Prediction Result',
                predictionStatus: 'Prediction Status',
                abnormalProbability: 'Abnormal Probability',
                riskLevel: 'Risk Level',
                highRisk: 'High Risk',
                mediumRisk: 'Medium Risk',
                lowRisk: 'Low Risk',
                normal: 'Normal',
                abnormal: 'Abnormal',
                recommendations: 'Clinical Recommendations',
                addDrug: 'Add This Drug',
                basedOn: 'Based on',
                predict: 'predict',
                risk: 'risk',
                noResults: 'No significant protective combination effects found',
                overallRiskLevel: 'Overall Risk Level',
                averageRelativeRisk: 'Average Relative Risk',
                maxRelativeRisk: 'Max Relative Risk',
                analyzedCombinations: 'Analyzed Combinations',
                predictionResult: 'Prediction Result',
                suggestMonitor: 'Organ dysfunction may occur, closely monitor relevant indicators (BUN, INR, albumin, etc.)',
                predictionNormal: 'Current prediction is normal, continue monitoring',
                solution: 'Solution',
                checkApiRunning: 'Check if API service is running',
                checkApiHealth: 'Visit health check endpoint to view service status',
                restartApi: 'If model is not loaded, restart API service',
                checkApiLogs: 'Check API startup logs to confirm model loading',
                modelNotLoaded: 'Prediction model not loaded',
                drugAlreadySelected: 'This drug is already in the selection list',
                foundChineseButNoEnglish: 'Found Chinese name but no corresponding English drug in the list',
                suggestTryEnglish: 'Suggestion: Try entering English names',
                noMatchingDrugs: 'No matching drugs found',
                chineseNotInMap: 'This Chinese name may not be in the mapping table',
                tryCommonDrugs: 'Or try common drugs',
                checkSpelling: 'Please check if spelling is correct',
                tryPartialName: 'Or try entering partial name',
                preventOrganDysfunction: 'Recommended Drugs to Prevent Multi-Organ Dysfunction',
                basedOnAnalysis: 'Based on data analysis and clinical knowledge, the following drugs may help reduce organ dysfunction risk',
                detectedRisk: 'Organ dysfunction risk detected, consider adding protective drugs',
                recommendedReason: 'Recommended Reason',
                riskReduction: 'Estimated Risk Reduction',
                addThisDrug: 'Add This Drug',
                noteRecommendations: 'Note: Recommended drugs are for reference only, actual use should be combined with clinical judgment and patient-specific situation',
                clinicalRecommendations: 'Clinical Recommendations',
                noData: 'No relevant data',
                riskyCombinations: 'High-Risk Drug Combinations',
                effectiveCombinations: 'Effective Drug Combinations',
                relativeRisk: 'Relative Risk',
                comboWith: 'with',
                comboWithSuffix: 'combination',
                potentialRiskReduction: 'Potential Risk Reduction',
                drugRecommendation: 'Drug Recommendation',
                noRecommendationData: 'Organ dysfunction risk detected, but no recommendation data available',
                suggestionAntioxidant: 'Suggestion: Consider using antioxidants (e.g., N-acetylcysteine), vitamins, or organ-protective drugs according to clinical guidelines'
            },
            fr: {
                title: 'ğŸ’Š SystÃ¨me d\'Analyse de Combinaisons MÃ©dicamenteuses',
                subtitle: 'Analyser les risques et l\'efficacitÃ© de toute combinaison de mÃ©dicaments',
                section1Title: '1. SÃ©lectionner les MÃ©dicaments',
                drugSearchLabel: 'Rechercher et ajouter des mÃ©dicaments (supporte le chinois et l\'anglais)',
                drugSearchPlaceholder: 'Entrez le nom du mÃ©dicament Ã  rechercher (ex: pÃ©nicilline, aspirine, prednisone)...',
                drugSearchHint: 'ğŸ’¡ Astuce: Supporte la recherche en chinois ou en anglais (ex: pÃ©nicilline, aspirine, prednisone)',
                btnAnalyze: 'DÃ©marrer l\'Analyse',
                loadingText: 'Analyse de la combinaison de mÃ©dicaments en cours, veuillez patienter...',
                resultsTitle: 'RÃ©sultats de l\'Analyse',
                overallRiskTitle: 'Ã‰valuation Globale des Risques',
                organPredictionTitle: 'PrÃ©diction de Dysfonctionnement Multi-Organes',
                kidneyAbnormal: 'Dysfonctionnement RÃ©nal',
                liverAbnormal: 'Dysfonctionnement HÃ©patique',
                organAbnormal: 'Dysfonctionnement Multi-Organes',
                noDrugsSelected: 'Aucun mÃ©dicament sÃ©lectionnÃ©',
                selectAtLeast2: 'Veuillez sÃ©lectionner au moins 2 mÃ©dicaments',
                currentSelected: 'Actuellement sÃ©lectionnÃ©',
                drugs: 'mÃ©dicaments',
                selectedDrugs: 'MÃ©dicaments sÃ©lectionnÃ©s',
                analyzing: 'Analyse en cours...',
                errorApiConnection: 'Impossible de se connecter au service API, veuillez vous assurer que le service API est en cours d\'exÃ©cution',
                errorApiTimeout: 'DÃ©lai d\'attente du service API dÃ©passÃ©, le service gratuit peut nÃ©cessiter 30 secondes pour dÃ©marrer, veuillez rÃ©essayer plus tard',
                serviceStarting: 'Le service dÃ©marre, veuillez patienter... (Le premier accÃ¨s peut prendre 30 secondes)',
                errorNoDrugs: 'Aucun mÃ©dicament correspondant trouvÃ©',
                errorTryEnglish: 'Veuillez essayer d\'entrer des noms anglais',
                predictionResult: 'RÃ©sultat de la PrÃ©diction',
                predictionStatus: 'Statut de la PrÃ©diction',
                abnormalProbability: 'ProbabilitÃ© d\'Anomalie',
                riskLevel: 'Niveau de Risque',
                highRisk: 'Risque Ã‰levÃ©',
                mediumRisk: 'Risque Moyen',
                lowRisk: 'Risque Faible',
                normal: 'Normal',
                abnormal: 'Anormal',
                recommendations: 'Recommandations Cliniques',
                addDrug: 'Ajouter ce MÃ©dicament',
                basedOn: 'BasÃ© sur',
                predict: 'prÃ©dire',
                risk: 'risque',
                noResults: 'Aucun effet protecteur significatif de combinaison trouvÃ©',
                overallRiskLevel: 'Niveau de Risque Global',
                averageRelativeRisk: 'Risque Relatif Moyen',
                maxRelativeRisk: 'Risque Relatif Maximum',
                analyzedCombinations: 'Combinaisons AnalysÃ©es',
                predictionResult: 'RÃ©sultat de la PrÃ©diction',
                suggestMonitor: 'Un dysfonctionnement d\'organe peut survenir, surveiller de prÃ¨s les indicateurs pertinents (BUN, INR, albumine, etc.)',
                predictionNormal: 'La prÃ©diction actuelle est normale, continuer la surveillance',
                solution: 'Solution',
                checkApiRunning: 'VÃ©rifier si le service API est en cours d\'exÃ©cution',
                checkApiHealth: 'Visiter le point de contrÃ´le de santÃ© pour voir l\'Ã©tat du service',
                restartApi: 'Si le modÃ¨le n\'est pas chargÃ©, redÃ©marrer le service API',
                checkApiLogs: 'VÃ©rifier les journaux de dÃ©marrage de l\'API pour confirmer le chargement du modÃ¨le',
                modelNotLoaded: 'ModÃ¨le de prÃ©diction non chargÃ©',
                drugAlreadySelected: 'Ce mÃ©dicament est dÃ©jÃ  dans la liste de sÃ©lection',
                foundChineseButNoEnglish: 'Nom chinois trouvÃ© mais aucun mÃ©dicament anglais correspondant dans la liste',
                suggestTryEnglish: 'Suggestion: Essayez d\'entrer des noms anglais',
                noMatchingDrugs: 'Aucun mÃ©dicament correspondant trouvÃ©',
                chineseNotInMap: 'Ce nom chinois peut ne pas Ãªtre dans la table de correspondance',
                tryCommonDrugs: 'Ou essayez des mÃ©dicaments courants',
                checkSpelling: 'Veuillez vÃ©rifier si l\'orthographe est correcte',
                tryPartialName: 'Ou essayez d\'entrer un nom partiel',
                preventOrganDysfunction: 'MÃ©dicaments RecommandÃ©s pour PrÃ©venir le Dysfonctionnement Multi-Organes',
                basedOnAnalysis: 'BasÃ© sur l\'analyse des donnÃ©es et les connaissances cliniques, les mÃ©dicaments suivants peuvent aider Ã  rÃ©duire le risque de dysfonctionnement d\'organe',
                detectedRisk: 'Risque de dysfonctionnement d\'organe dÃ©tectÃ©, envisager d\'ajouter des mÃ©dicaments protecteurs',
                recommendedReason: 'Raison de la Recommandation',
                riskReduction: 'RÃ©duction du Risque EstimÃ©e',
                addThisDrug: 'Ajouter ce MÃ©dicament',
                noteRecommendations: 'Note: Les mÃ©dicaments recommandÃ©s sont Ã  titre indicatif uniquement, l\'utilisation rÃ©elle doit Ãªtre combinÃ©e avec le jugement clinique et la situation spÃ©cifique du patient',
                clinicalRecommendations: 'Recommandations Cliniques',
                noData: 'Aucune donnÃ©e pertinente',
                riskyCombinations: 'Combinaisons de MÃ©dicaments Ã  Risque Ã‰levÃ©',
                effectiveCombinations: 'Combinaisons de MÃ©dicaments Efficaces',
                relativeRisk: 'Risque Relatif',
                comboWith: 'avec',
                comboWithSuffix: 'combinaison',
                potentialRiskReduction: 'RÃ©duction Potentielle du Risque',
                drugRecommendation: 'Recommandation de MÃ©dicament',
                noRecommendationData: 'Risque de dysfonctionnement d\'organe dÃ©tectÃ©, mais aucune donnÃ©e de recommandation disponible',
                suggestionAntioxidant: 'Suggestion: Envisager d\'utiliser des antioxydants (par ex., N-acÃ©tylcystÃ©ine), des vitamines, ou des mÃ©dicaments protecteurs d\'organes selon les directives cliniques'
            }
        };
        
        // è·å–ç¿»è¯‘æ–‡æœ¬
        function t(key) {
            return i18n[currentLanguage][key] || key;
        }
        
        // ç¿»è¯‘åç«¯è¿”å›çš„interpretationæ–‡æœ¬
        function translateInterpretation(interpretation) {
            if (!interpretation) return '';
            
            // å¦‚æœå½“å‰æ˜¯ä¸­æ–‡ï¼Œç›´æ¥è¿”å›
            if (currentLanguage === 'zh') {
                return interpretation;
            }
            
            // ç¿»è¯‘ä¸­æ–‡interpretationåˆ°è‹±æ–‡æˆ–æ³•æ–‡
            const translations = {
                'é«˜é£é™©ï¼šè¯¥è¯ç‰©ç»„åˆæ˜¾è‘—å¢åŠ ä¸è‰¯ç»“å±€é£é™©': {
                    en: 'High Risk: This drug combination significantly increases adverse outcome risk',
                    fr: 'Risque Ã‰levÃ©: Cette combinaison de mÃ©dicaments augmente significativement le risque d\'issue dÃ©favorable'
                },
                'ä¸­ç­‰é£é™©ï¼šè¯¥è¯ç‰©ç»„åˆå¯èƒ½å¢åŠ ä¸è‰¯ç»“å±€é£é™©': {
                    en: 'Medium Risk: This drug combination may increase adverse outcome risk',
                    fr: 'Risque Moyen: Cette combinaison de mÃ©dicaments peut augmenter le risque d\'issue dÃ©favorable'
                },
                'ä¿æŠ¤æ€§ï¼šè¯¥è¯ç‰©ç»„åˆå¯èƒ½é™ä½ä¸è‰¯ç»“å±€é£é™©': {
                    en: 'Protective: This drug combination may reduce adverse outcome risk',
                    fr: 'Protecteur: Cette combinaison de mÃ©dicaments peut rÃ©duire le risque d\'issue dÃ©favorable'
                },
                'å¯èƒ½ä¿æŠ¤æ€§ï¼šè¯¥è¯ç‰©ç»„åˆå¯èƒ½ç•¥å¾®é™ä½ä¸è‰¯ç»“å±€é£é™©': {
                    en: 'Potentially Protective: This drug combination may slightly reduce adverse outcome risk',
                    fr: 'Potentiellement Protecteur: Cette combinaison de mÃ©dicaments peut lÃ©gÃ¨rement rÃ©duire le risque d\'issue dÃ©favorable'
                },
                'ä¸­æ€§ï¼šè¯¥è¯ç‰©ç»„åˆå¯¹ç»“å±€å½±å“ä¸æ˜æ˜¾': {
                    en: 'Neutral: This drug combination has no significant effect on outcomes',
                    fr: 'Neutre: Cette combinaison de mÃ©dicaments n\'a pas d\'effet significatif sur les issues'
                }
            };
            
            // ç²¾ç¡®åŒ¹é…
            if (translations[interpretation]) {
                return translations[interpretation][currentLanguage] || interpretation;
            }
            
            // éƒ¨åˆ†åŒ¹é…ï¼ˆå¤„ç†å¯èƒ½çš„å˜ä½“ï¼‰
            for (const [chinese, trans] of Object.entries(translations)) {
                if (interpretation.includes(chinese.split('ï¼š')[0]) || interpretation.includes(chinese.split('ï¼š')[1])) {
                    return trans[currentLanguage] || interpretation;
                }
            }
            
            // å¦‚æœæ— æ³•ç¿»è¯‘ï¼Œè¿”å›åŸæ–‡
            return interpretation;
        }
        
        // åˆ‡æ¢è¯­è¨€
        function switchLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            
            // æ›´æ–°è¯­è¨€æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-lang') === lang) {
                    btn.classList.add('active');
                }
            });
            
            // æ›´æ–°HTML langå±æ€§
            document.documentElement.lang = lang === 'zh' ? 'zh-CN' : lang;
            
            // æ›´æ–°æ‰€æœ‰æ–‡æœ¬
            updateTexts();
        }
        
        // æ›´æ–°æ‰€æœ‰æ–‡æœ¬å†…å®¹
        function updateTexts() {
            // æ›´æ–°æ ‡é¢˜å’Œå‰¯æ ‡é¢˜
            document.getElementById('title').textContent = t('title');
            document.getElementById('subtitle').textContent = t('subtitle');
            
            // æ›´æ–°è¡¨å•æ ‡ç­¾
            document.getElementById('section1Title').textContent = t('section1Title');
            document.getElementById('drugSearchLabel').textContent = t('drugSearchLabel');
            document.getElementById('drugSearch').placeholder = t('drugSearchPlaceholder');
            document.getElementById('drugSearchHint').textContent = t('drugSearchHint');
            document.getElementById('analyzeBtn').textContent = t('btnAnalyze');
            
            // æ›´æ–°åŠ è½½æ–‡æœ¬
            document.getElementById('loadingText').textContent = t('loadingText');
            
            // æ›´æ–°ç»“æœæ ‡é¢˜
            document.getElementById('resultsTitle').textContent = t('resultsTitle');
            document.getElementById('overallRiskTitle').textContent = t('overallRiskTitle');
            document.getElementById('organPredictionTitle').textContent = t('organPredictionTitle');
            
            // æ›´æ–°å·²é€‰è¯ç‰©æ˜¾ç¤º
            updateSelectedDrugs();
        }
        
        // ä¸­æ–‡è¯ç‰©åç§°æ˜ å°„ï¼ˆæ‰©å±•ç‰ˆï¼‰
        const drugNameMap = {
            'é’éœ‰ç´ ': ['penicillin', 'piperacillin', 'nafcillin', 'ampicillin', 'amoxicillin'],
            'é˜¿å¸åŒ¹æ—': ['aspirin'],
            'é˜¿å¸åŒ¹': ['aspirin'],
            'é†‹é…¸æ³¼å°¼æ¾': ['prednisone', 'deltasone', 'methylprednisolone'],
            'æ³¼å°¼æ¾': ['prednisone', 'deltasone'],
            'æ³¼å°¼': ['prednisone', 'deltasone'],
            'å¤´å­¢': ['cefazolin', 'ceftriaxone', 'cefepime', 'cephulac', 'cefuroxime'],
            'å¤´å­¢æ›²æ¾': ['ceftriaxone'],
            'å¤´å­¢å”‘æ—': ['cefazolin'],
            'å¤´å­¢ä»–å•¶': ['ceftazidime'],
            'ä¸‡å¤éœ‰ç´ ': ['vancomycin'],
            'å‘‹å¡ç±³': ['furosemide'],
            'å¸ƒç¾ä»–å°¼': ['bumetanide', 'bumex'],
            'å¯¹ä¹™é…°æ°¨åŸºé…š': ['acetaminophen', 'acetamin', 'tylenol'],
            'ä»–æ±€': ['atorvastatin', 'simvastatin', 'lipitor', 'zocor'],
            'é˜¿æ‰˜ä¼ä»–æ±€': ['atorvastatin', 'lipitor'],
            'è¾›ä¼ä»–æ±€': ['simvastatin', 'zocor'],
            'èƒ°å²›ç´ ': ['insulin', 'humulin', 'lantus', 'levemir', 'glargine', 'lispro', 'detemir'],
            'è‚ç´ ': ['heparin'],
            'åœ°å¡ç±³æ¾': ['dexamethasone', 'decadron'],
            'ç”²æ³¼å°¼é¾™': ['methylprednisolone', 'medrol'],
            'ç¯ä¸™æ²™æ˜Ÿ': ['ciprofloxacin'],
            'å·¦æ°§æ°Ÿæ²™æ˜Ÿ': ['levofloxacin', 'levaquin'],
            'é˜¿å¥‡éœ‰ç´ ': ['azithromycin'],
            'ç¾ç½—åŸ¹å—': ['meropenem', 'merrem'],
            'å“Œæ‹‰è¥¿æ—': ['piperacillin', 'zosyn'],
            'å…‹æ—éœ‰ç´ ': ['clindamycin'],
            'ç”²ç¡å”‘': ['metronidazole', 'flagyl'],
            'é˜¿è«è¥¿æ—': ['amoxicillin', 'amoxil'],
            'æ°¨è‹„è¥¿æ—': ['ampicillin'],
            'åº†å¤§éœ‰ç´ ': ['gentamicin'],
            'å¦¥å¸ƒéœ‰ç´ ': ['tobramycin'],
            'å¤šè¥¿ç¯ç´ ': ['doxycycline'],
            'ç±³è¯ºç¯ç´ ': ['minocycline'],
            'çº¢éœ‰ç´ ': ['erythromycin'],
            'å…‹æ‹‰éœ‰ç´ ': ['clarithromycin'],
            'è«è¥¿æ²™æ˜Ÿ': ['moxifloxacin'],
            'è¯ºæ°Ÿæ²™æ˜Ÿ': ['norfloxacin'],
            'æ°§æ°Ÿæ²™æ˜Ÿ': ['ofloxacin'],
            'åˆ©ç¦å¹³': ['rifampin', 'rifampicin'],
            'å¼‚çƒŸè‚¼': ['isoniazid'],
            'ä¹™èƒºä¸é†‡': ['ethambutol'],
            'å¡å—ªé…°èƒº': ['pyrazinamide']
        };
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åº”ç”¨ä¿å­˜çš„è¯­è¨€è®¾ç½®
            switchLanguage(currentLanguage);
            loadDrugs();
            setupDrugSearch();
        });
        
        // å¸¦è¶…æ—¶å’Œé‡è¯•çš„fetchå‡½æ•°
        async function fetchWithTimeout(url, options = {}, timeout = 45000, maxRetries = 1) {
            let lastError = null;
            
            for (let attempt = 0; attempt <= maxRetries; attempt++) {
                try {
                    if (attempt > 0) {
                        // é‡è¯•å‰ç­‰å¾…ï¼Œæ¯æ¬¡é‡è¯•ç­‰å¾…æ—¶é—´é€’å¢
                        const waitTime = Math.min(1000 * Math.pow(2, attempt - 1), 5000);
                        console.log(`ç¬¬ ${attempt + 1} æ¬¡å°è¯•ï¼Œç­‰å¾… ${waitTime}ms...`);
                        await new Promise(resolve => setTimeout(resolve, waitTime));
                    }
                    
                    // æ¯æ¬¡å°è¯•åˆ›å»ºæ–°çš„controller
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), timeout);
                    
                    try {
                        const response = await fetch(url, {
                            ...options,
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        return response;
                    } finally {
                        clearTimeout(timeoutId);
                    }
                } catch (error) {
                    lastError = error;
                    
                    // å¦‚æœæ˜¯è¶…æ—¶æˆ–ç½‘ç»œé”™è¯¯ï¼Œä¸”è¿˜æœ‰é‡è¯•æœºä¼šï¼Œåˆ™ç»§ç»­é‡è¯•
                    if (attempt < maxRetries && (error.name === 'AbortError' || error.name === 'TypeError')) {
                        console.warn(`è¯·æ±‚å¤±è´¥ (å°è¯• ${attempt + 1}/${maxRetries + 1}):`, error.message);
                        continue;
                    }
                    
                    // å¦‚æœæ˜¯æœ€åä¸€æ¬¡å°è¯•ï¼Œæˆ–è€…ä¸æ˜¯å¯é‡è¯•çš„é”™è¯¯ï¼Œåˆ™æŠ›å‡ºé”™è¯¯
                    throw error;
                }
            }
            
            throw lastError || new Error('è¯·æ±‚å¤±è´¥');
        }
        
        // åŠ è½½æ‰€æœ‰è¯ç‰©åˆ—è¡¨
        async function loadDrugs() {
            try {
                console.log(`æ­£åœ¨è¿æ¥åˆ°API: ${API_BASE}`);
                // é¦–æ¬¡å°è¯•æ˜¾ç¤ºå¯åŠ¨æç¤º
                const loadingHint = document.getElementById('drugSearchHint');
                if (loadingHint) {
                    const originalText = loadingHint.textContent;
                    loadingHint.textContent = t('serviceStarting');
                    loadingHint.style.color = '#667eea';
                }
                
                const response = await fetchWithTimeout(
                    `${API_BASE}/drugs/list?limit=1000`,
                    {},
                    45000, // 45ç§’è¶…æ—¶ï¼ˆRenderå…è´¹ç‰ˆå¯èƒ½éœ€è¦30ç§’å¯åŠ¨ï¼‰
                    1      // æœ€å¤šé‡è¯•1æ¬¡ï¼ˆæ€»å…±2æ¬¡å°è¯•ï¼‰
                );
                
                const data = await response.json();
                if (data.success) {
                    allDrugs = data.drugs;
                    console.log(`âœ… åŠ è½½äº† ${allDrugs.length} ç§è¯ç‰©`);
                    
                    // æ¢å¤æç¤ºæ–‡æœ¬
                    if (loadingHint) {
                        loadingHint.textContent = t('drugSearchHint');
                        loadingHint.style.color = '#666';
                    }
                }
            } catch (error) {
                console.error('âŒ åŠ è½½è¯ç‰©åˆ—è¡¨å¤±è´¥:', error);
                
                // æ¢å¤æç¤ºæ–‡æœ¬
                const loadingHint = document.getElementById('drugSearchHint');
                if (loadingHint) {
                    loadingHint.textContent = t('drugSearchHint');
                    loadingHint.style.color = '#666';
                }
                
                // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒçš„é”™è¯¯æ¶ˆæ¯
                if (error.name === 'AbortError') {
                    showError(t('errorApiTimeout'));
                } else {
                    showError(t('errorApiConnection') + ' ' + error.message);
                }
            }
        }
        
        // ä¸­æ–‡æœç´¢è½¬æ¢ä¸ºè‹±æ–‡ï¼ˆæ”¹è¿›ç‰ˆï¼Œæ”¯æŒéƒ¨åˆ†åŒ¹é…å’Œæ¨¡ç³Šæœç´¢ï¼‰
        function translateChineseToEnglish(query) {
            const lowerQuery = query.toLowerCase().trim();
            if (!lowerQuery) return null;
            
            // ç²¾ç¡®åŒ¹é…
            for (const [chinese, englishNames] of Object.entries(drugNameMap)) {
                if (chinese === lowerQuery || lowerQuery === chinese) {
                    return englishNames;
                }
            }
            
            // éƒ¨åˆ†åŒ¹é…ï¼ˆä¸­æ–‡åŒ…å«æŸ¥è¯¢æˆ–æŸ¥è¯¢åŒ…å«ä¸­æ–‡ï¼‰
            for (const [chinese, englishNames] of Object.entries(drugNameMap)) {
                if (chinese.includes(lowerQuery) || lowerQuery.includes(chinese)) {
                    return englishNames;
                }
            }
            
            // æ¨¡ç³ŠåŒ¹é…ï¼šæ£€æŸ¥æŸ¥è¯¢æ˜¯å¦åŒ…å«ä¸­æ–‡åç§°çš„ä¸€éƒ¨åˆ†ï¼ˆä»…å½“æŸ¥è¯¢é•¿åº¦>=2æ—¶ï¼Œé¿å…å•ä¸ªå­—ç¬¦åŒ¹é…å¤ªå¤šç»“æœï¼‰
            if (query.length >= 2) {
                for (const [chinese, englishNames] of Object.entries(drugNameMap)) {
                    // æ£€æŸ¥æŸ¥è¯¢æ˜¯å¦åŒ…å«ä¸­æ–‡åç§°çš„ä»»æ„å­—ç¬¦
                    const chineseChars = chinese.split('');
                    const queryChars = lowerQuery.split('');
                    // å¦‚æœæŸ¥è¯¢ä¸­çš„å­—ç¬¦åœ¨ä¸­æ–‡åç§°ä¸­å‡ºç°ï¼Œå¯èƒ½æ˜¯åŒ¹é…çš„
                    // ä½†è¦æ±‚è‡³å°‘åŒ¹é…2ä¸ªå­—ç¬¦ï¼Œæˆ–è€…æŸ¥è¯¢æ˜¯ä¸­æ–‡åç§°çš„å¼€å¤´éƒ¨åˆ†
                    const matchedChars = queryChars.filter(qc => chineseChars.includes(qc)).length;
                    if (matchedChars >= 2 || chinese.startsWith(lowerQuery) || lowerQuery.startsWith(chinese.substring(0, Math.min(query.length, chinese.length)))) {
                        return englishNames;
                    }
                }
            }
            
            return null;
        }
        
        // åå‘æŸ¥æ‰¾ï¼šä»è‹±æ–‡è¯ç‰©åç§°æŸ¥æ‰¾å¯¹åº”çš„ä¸­æ–‡åç§°
        function getChineseDrugName(englishDrug) {
            if (!englishDrug) return null;
            const lowerDrug = englishDrug.toLowerCase();
            
            for (const [chinese, englishNames] of Object.entries(drugNameMap)) {
                if (englishNames.some(en => lowerDrug.includes(en.toLowerCase()) || en.toLowerCase().includes(lowerDrug))) {
                    return chinese;
                }
            }
            return null;
        }
        
        // è®¾ç½®è¯ç‰©æœç´¢
        function setupDrugSearch() {
            const searchInput = document.getElementById('drugSearch');
            const dropdown = document.getElementById('drugDropdown');
            
            searchInput.addEventListener('input', function() {
                const query = this.value.trim();
                if (query.length < 1) {
                    dropdown.classList.remove('show');
                    return;
                }
                
                let filtered = [];
                const lowerQuery = query.toLowerCase();
                
                // 1. å…ˆæ£€æŸ¥æ˜¯å¦æ˜¯ä¸­æ–‡è¯ç‰©åç§°
                const translated = translateChineseToEnglish(query);
                if (translated) {
                    // å¦‚æœè¯ç‰©åˆ—è¡¨ä¸ºç©ºï¼Œæ˜¾ç¤ºå‹å¥½æç¤º
                    if (allDrugs.length === 0) {
                        dropdown.innerHTML = `
                            <div class="drug-option" style="color: #ff9800; cursor: default;">
                                âš ï¸ ${t('errorApiConnection')}
                            </div>
                            <div class="drug-option" style="color: #666; cursor: default; font-size: 12px;">
                                ${t('drugSearchHint')}
                            </div>
                        `;
                        dropdown.classList.add('show');
                        return;
                    }
                    
                    // æŸ¥æ‰¾åŒ¹é…çš„è‹±æ–‡è¯ç‰©ï¼ˆæ”¯æŒéƒ¨åˆ†åŒ¹é…ï¼‰
                    filtered = allDrugs.filter(drug => {
                        const lowerDrug = drug.toLowerCase();
                        return translated.some(en => {
                            const lowerEn = en.toLowerCase();
                            // å®Œå…¨åŒ¹é…æˆ–åŒ…å«åŒ¹é…
                            return lowerDrug === lowerEn || 
                                   lowerDrug.includes(lowerEn) || 
                                   lowerEn.includes(lowerDrug);
                        });
                    }).slice(0, 20);
                    
                    // æ˜¾ç¤ºä¸­æ–‡æç¤ºï¼ˆä»…åœ¨ä¸­æ–‡è¯­è¨€ç¯å¢ƒä¸‹æ˜¾ç¤ºä¸­æ–‡åç§°ï¼‰
                    if (filtered.length > 0) {
                        dropdown.innerHTML = filtered.map(drug => {
                            // åªåœ¨ä¸­æ–‡ç¯å¢ƒä¸‹æ˜¾ç¤ºä¸­æ–‡åç§°
                            if (currentLanguage === 'zh') {
                                const chineseName = getChineseDrugName(drug);
                                const displayName = chineseName ? `${drug} (${chineseName})` : drug;
                                return `<div class="drug-option" onclick="selectDrug('${drug}')">${displayName}</div>`;
                            } else {
                                return `<div class="drug-option" onclick="selectDrug('${drug}')">${drug}</div>`;
                            }
                        }).join('');
                        dropdown.classList.add('show');
                        return;
                    } else {
                        // æ‰¾åˆ°äº†ä¸­æ–‡æ˜ å°„ï¼Œä½†åœ¨è¯ç‰©åˆ—è¡¨ä¸­æ‰¾ä¸åˆ°å¯¹åº”çš„è‹±æ–‡è¯ç‰©
                        // æ˜¾ç¤ºå»ºè®®çš„è‹±æ–‡åç§°ï¼Œå¹¶æç¤ºå¯ä»¥ç›´æ¥è¾“å…¥è‹±æ–‡åç§°æœç´¢
                        dropdown.innerHTML = `
                            <div class="drug-option" style="color: #ff9800; cursor: default;">
                                âš ï¸ ${t('foundChineseButNoEnglish')}
                            </div>
                            <div class="drug-option" style="color: #666; cursor: default; font-size: 12px;">
                                ${t('suggestTryEnglish')}: ${translated.slice(0, 3).join(', ')}
                            </div>
                            <div class="drug-option" style="color: #666; cursor: default; font-size: 11px; margin-top: 5px;">
                                ğŸ’¡ ${currentLanguage === 'zh' ? 'æç¤ºï¼šæ‚¨ä¹Ÿå¯ä»¥ç›´æ¥è¾“å…¥è‹±æ–‡åç§°è¿›è¡Œæœç´¢' : 'Tip: You can also type English names directly'}
                            </div>
                        `;
                        dropdown.classList.add('show');
                        return;
                    }
                }
                
                // 2. è‹±æ–‡æœç´¢
                filtered = allDrugs.filter(drug => 
                    drug.toLowerCase().includes(lowerQuery)
                ).slice(0, 20);
                
                if (filtered.length > 0) {
                    dropdown.innerHTML = filtered.map(drug => 
                        `<div class="drug-option" onclick="selectDrug('${drug}')">${drug}</div>`
                    ).join('');
                    dropdown.classList.add('show');
                } else {
                    // æœªæ‰¾åˆ°åŒ¹é…ï¼Œæä¾›å¸®åŠ©ä¿¡æ¯
                    let helpText = t('noMatchingDrugs');
                    let suggestions = [];
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ä¸­æ–‡è¾“å…¥ä½†æœªåœ¨æ˜ å°„è¡¨ä¸­
                    const isChinese = /[\u4e00-\u9fa5]/.test(query);
                    if (isChinese) {
                        helpText = `${t('noMatchingDrugs')}: "${query}"`;
                        suggestions.push(t('chineseNotInMap'));
                        suggestions.push(t('errorTryEnglish'));
                        // æä¾›ä¸€äº›å¸¸è§è¯ç‰©çš„å»ºè®®
                        const commonSuggestions = ['aspirin', 'prednisone', 'piperacillin', 'vancomycin'];
                        suggestions.push(`${t('tryCommonDrugs')}: ${commonSuggestions.join(', ')}`);
                    } else {
                        suggestions.push(t('checkSpelling'));
                        suggestions.push(t('tryPartialName'));
                    }
                    
                    dropdown.innerHTML = `
                        <div class="drug-option" style="color: #999; cursor: default; padding: 15px;">
                            <div style="margin-bottom: 8px;">${helpText}</div>
                            <div style="font-size: 12px; color: #666;">
                                ${suggestions.map(s => `<div style="margin: 4px 0;">â€¢ ${s}</div>`).join('')}
                            </div>
                        </div>
                    `;
                    dropdown.classList.add('show');
                }
            });
            
            // æ”¯æŒå›è½¦é”®å¿«é€Ÿé€‰æ‹©ç¬¬ä¸€ä¸ªç»“æœ
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && dropdown.classList.contains('show')) {
                    const firstOption = dropdown.querySelector('.drug-option');
                    if (firstOption && firstOption.onclick) {
                        firstOption.click();
                    }
                }
            });
            
            // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰æ¡†
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });
        }
        
        // å¿«é€Ÿæ·»åŠ å¸¸ç”¨è¯ç‰©ç»„åˆ
        function addCommonCombination() {
            const commonDrugs = {
                'é’éœ‰ç´ ç±»': ['piperacillin', 'nafcillin'],
                'å¤´å­¢ç±»': ['ceftriaxone', 'cefazolin'],
                'é˜¿å¸åŒ¹æ—+æ³¼å°¼æ¾': ['aspirin', 'prednisone'],
                'é’éœ‰ç´ +é˜¿å¸åŒ¹æ—+æ³¼å°¼æ¾': ['piperacillin', 'aspirin', 'prednisone']
            };
            
            // å¯ä»¥æ·»åŠ ä¸€ä¸ªå¿«é€Ÿé€‰æ‹©æŒ‰é’®
            console.log('å¸¸ç”¨ç»„åˆ:', commonDrugs);
        }
        
        // é€‰æ‹©è¯ç‰©
        function selectDrug(drug) {
            if (!selectedDrugs.includes(drug)) {
                selectedDrugs.push(drug);
                updateSelectedDrugs();
            }
            document.getElementById('drugSearch').value = '';
            document.getElementById('drugDropdown').classList.remove('show');
        }
        
        // æ›´æ–°å·²é€‰è¯ç‰©æ˜¾ç¤º
        function updateSelectedDrugs() {
            const container = document.getElementById('selectedDrugs');
            if (selectedDrugs.length === 0) {
                container.innerHTML = `<div style="color: #999; padding: 10px;">${t('noDrugsSelected')}</div>`;
            } else {
                container.innerHTML = selectedDrugs.map(drug => {
                    // åªåœ¨ä¸­æ–‡ç¯å¢ƒä¸‹æ˜¾ç¤ºä¸­æ–‡åç§°
                    let displayName = drug;
                    if (currentLanguage === 'zh') {
                        const chineseName = getChineseDrugName(drug);
                        displayName = chineseName ? `${drug} (${chineseName})` : drug;
                    }
                    return `<div class="drug-tag">
                        ${displayName}
                        <span class="remove" onclick="removeDrug('${drug}')">Ã—</span>
                    </div>`;
                }).join('');
            }
            
            const btn = document.getElementById('analyzeBtn');
            btn.disabled = selectedDrugs.length < 2;
            if (selectedDrugs.length < 2) {
                btn.title = t('selectAtLeast2');
            } else {
                btn.title = `${t('currentSelected')} ${selectedDrugs.length} ${t('drugs')}ï¼Œ${t('btnAnalyze')}`;
            }
        }
        
        // ç§»é™¤è¯ç‰©
        function removeDrug(drug) {
            selectedDrugs = selectedDrugs.filter(d => d !== drug);
            updateSelectedDrugs();
        }
        
        // åˆ†æè¯ç‰©ç»„åˆ
        async function analyzeCombination() {
            if (selectedDrugs.length < 2) {
                alert(`${t('selectAtLeast2')}\n\n${t('currentSelected')}: ${selectedDrugs.length} ${t('drugs')}\n${t('selectedDrugs')}: ${selectedDrugs.join(', ') || t('noDrugsSelected')}`);
                return;
            }
            
            console.log('å¼€å§‹åˆ†æè¯ç‰©ç»„åˆ:', selectedDrugs);
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loading').classList.add('show');
            document.getElementById('results').classList.remove('show');
            document.getElementById('error').style.display = 'none';
            
            try {
                // æ„å»ºæ‚£è€…æ•°æ®
                const patientData = {};
                selectedDrugs.forEach(drug => {
                    patientData[drug] = 1;
                });
                
                // æ·»åŠ å®éªŒå®¤æŒ‡æ ‡ï¼ˆé»˜è®¤æ­£å¸¸å€¼ï¼‰
                patientData.bun = 0;
                patientData.inr = 0;
                patientData.lactate = 0;
                patientData.platelets = 0;
                patientData.wbc = 0;
                patientData.albu_lab = 0;
                patientData.o2sat = 0;
                patientData.pao2 = 0;
                patientData.paco2 = 0;
                patientData.ph = 0;
                patientData.bands = 0;
                patientData.hct = 0;
                
                // åŒæ—¶è°ƒç”¨è¯ç‰©ç»„åˆåˆ†æã€å™¨å®˜åŠŸèƒ½é¢„æµ‹å’Œè¯ç‰©æ¨è
                // ä½¿ç”¨å¸¦è¶…æ—¶çš„fetchï¼Œä½†åªå¯¹ä¸»è¦è¯·æ±‚é‡è¯•
                const [combinationResponse, predictResponse, recommendResponse] = await Promise.all([
                    fetchWithTimeout(`${API_BASE}/drug_combinations`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(patientData)
                    }, 45000, 1).catch(e => {
                        console.error('è¯ç‰©ç»„åˆåˆ†æè¯·æ±‚å¤±è´¥:', e);
                        throw e; // ä¸»è¦è¯·æ±‚å¤±è´¥åˆ™æŠ›å‡ºé”™è¯¯
                    }),
                    fetchWithTimeout(`${API_BASE}/predict`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(patientData)
                    }, 30000, 0).catch(e => {
                        console.warn('é¢„æµ‹è¯·æ±‚å¤±è´¥:', e);
                        return null; // é¢„æµ‹å¤±è´¥ï¼Œç»§ç»­æ˜¾ç¤ºç»„åˆåˆ†æ
                    }),
                    fetchWithTimeout(`${API_BASE}/drugs/recommend`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ drugs: selectedDrugs })
                    }, 30000, 0).catch(e => {
                        console.warn('æ¨èè¯·æ±‚å¤±è´¥:', e);
                        return null; // æ¨èå¤±è´¥ï¼Œç»§ç»­æ˜¾ç¤ºå…¶ä»–ç»“æœ
                    })
                ]);
                
                const combinationData = await combinationResponse.json();
                let predictData = null;
                if (predictResponse) {
                    try {
                        if (predictResponse.ok) {
                            predictData = await predictResponse.json();
                            console.log('é¢„æµ‹APIå“åº”:', predictData);
                        } else {
                            const errorData = await predictResponse.json().catch(() => ({}));
                            console.warn('é¢„æµ‹APIè¿”å›é”™è¯¯:', predictResponse.status, errorData);
                            // å³ä½¿é¢„æµ‹å¤±è´¥ï¼Œä¹Ÿç»§ç»­æ˜¾ç¤ºå…¶ä»–ç»“æœ
                            const errorMsg = currentLanguage === 'zh' ? 'é¢„æµ‹æœåŠ¡ä¸å¯ç”¨' : 
                                           currentLanguage === 'fr' ? 'Service de prÃ©diction indisponible' : 
                                           'Prediction service unavailable';
                            predictData = { error: errorData.error || errorMsg };
                        }
                    } catch (e) {
                        console.warn('é¢„æµ‹APIè°ƒç”¨å¤±è´¥:', e);
                        const errorMsg = currentLanguage === 'zh' ? 'æ— æ³•è¿æ¥åˆ°é¢„æµ‹æœåŠ¡' : 
                                       currentLanguage === 'fr' ? 'Impossible de se connecter au service de prÃ©diction' : 
                                       'Cannot connect to prediction service';
                        predictData = { error: errorMsg };
                    }
                } else {
                    console.warn('é¢„æµ‹APIè¯·æ±‚å¤±è´¥ï¼ŒpredictResponseä¸ºnull');
                    const errorMsg = currentLanguage === 'zh' ? 'é¢„æµ‹æœåŠ¡æœªå“åº”' : 
                                   currentLanguage === 'fr' ? 'Le service de prÃ©diction n\'a pas rÃ©pondu' : 
                                   'Prediction service did not respond';
                    predictData = { error: errorMsg };
                }
                
                let recommendData = null;
                if (recommendResponse) {
                    try {
                        recommendData = await recommendResponse.json();
                    } catch (e) {
                        console.warn('æ¨èAPIè°ƒç”¨å¤±è´¥:', e);
                    }
                }
                
                if (combinationData.success) {
                    displayResults(combinationData.analysis, predictData, recommendData);
                } else {
                    const errorMsg = currentLanguage === 'zh' ? 'åˆ†æå¤±è´¥' : 
                                   currentLanguage === 'fr' ? 'Ã‰chec de l\'analyse' : 
                                   'Analysis failed';
                    throw new Error(combinationData.error || errorMsg);
                }
            } catch (error) {
                const errorPrefix = currentLanguage === 'zh' ? 'åˆ†æå¤±è´¥: ' : 
                                  currentLanguage === 'fr' ? 'Ã‰chec de l\'analyse: ' : 
                                  'Analysis failed: ';
                showError(errorPrefix + error.message);
            } finally {
                document.getElementById('loading').classList.remove('show');
            }
        }
        
        // æ˜¾ç¤ºç»“æœ
        function displayResults(analysis, predictions = null, recommendations = null) {
            // æ€»ä½“é£é™©
            const overallRisk = analysis.overall_risk;
            const riskClass = overallRisk === 'high' ? 'risk-high' : 
                            overallRisk === 'medium' ? 'risk-medium' : 'risk-low';
            const riskText = overallRisk === 'high' ? t('highRisk') : 
                           overallRisk === 'medium' ? t('mediumRisk') : t('lowRisk');
            
            document.getElementById('overallRisk').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="label">${t('overallRiskLevel')}</div>
                        <div class="value"><span class="risk-badge ${riskClass}">${riskText}</span></div>
                    </div>
                    <div class="stat-item">
                        <div class="label">${t('averageRelativeRisk')}</div>
                        <div class="value">${analysis.average_relative_risk.toFixed(2)}</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">${t('maxRelativeRisk')}</div>
                        <div class="value">${analysis.max_relative_risk.toFixed(2)}</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">${t('analyzedCombinations')}</div>
                        <div class="value">${analysis.analyzed_combinations}</div>
                    </div>
                </div>
            `;
            
            // å¤šå™¨å®˜åŠŸèƒ½éšœç¢é¢„æµ‹æ ‡ç­¾é¡µ
            const organTypes = [
                { id: 'kidney', name: t('kidneyAbnormal'), key: 'kidney_abnormal', desc: currentLanguage === 'zh' ? `${t('basedOn')} BUN ${t('predict')} ${t('kidneyAbnormal')} ${t('risk')}` : `Predict ${t('kidneyAbnormal')} ${t('risk')} based on BUN and other indicators` },
                { id: 'liver', name: t('liverAbnormal'), key: 'liver_abnormal', desc: currentLanguage === 'zh' ? `${t('basedOn')} INRã€${t('basedOn')} ${t('predict')} ${t('liverAbnormal')} ${t('risk')}` : `Predict ${t('liverAbnormal')} ${t('risk')} based on INR, albumin and other indicators` },
                { id: 'organ', name: t('organAbnormal'), key: 'organ_abnormal', desc: currentLanguage === 'zh' ? `${t('basedOn')} ${t('predict')} ${t('kidneyAbnormal')} ${t('risk')}` : `Comprehensive prediction of kidney and liver dysfunction ${t('risk')}` }
            ];
            
            let tabsHtml = '';
            let contentHtml = '';
            
            organTypes.forEach((organ, index) => {
                const active = index === 0 ? 'active' : '';
                tabsHtml += `<button class="outcome-tab ${active}" onclick="switchOrgan('${organ.id}')">${organ.name}</button>`;
                
                let organHtml = `<div class="outcome-content ${active}" id="organ-${organ.id}">`;
                
                // æ˜¾ç¤ºé¢„æµ‹ç»“æœ
                // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
                if (predictions && predictions.error) {
                    organHtml += `
                        <div class="combination-item" style="background: #fff3cd; border-left: 4px solid #ffc107;">
                            <h4>${organ.name} ${t('predict')}</h4>
                            <p style="color: #856404; margin-bottom: 10px;">
                                âš ï¸ ${predictions.error}
                            </p>
                            <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 10px;">
                                <p style="font-size: 12px; color: #666; margin-bottom: 5px;"><strong>${t('solution')}:</strong></p>
                                <ol style="font-size: 12px; color: #666; margin-left: 20px; padding-left: 0;">
                                    <li>${t('checkApiRunning')}</li>
                                    <li>${t('checkApiHealth')}: <a href="http://localhost:5003/health" target="_blank">http://localhost:5003/health</a></li>
                                    <li>${t('restartApi')}: <code>python3 cdss_api.py</code></li>
                                    <li>${t('checkApiLogs')}</li>
                                </ol>
                            </div>
                        </div>
                    `;
                } else if (predictions && predictions.predictions && predictions.predictions[organ.key]) {
                    const pred = predictions.predictions[organ.key];
                    const isAbnormal = pred.prediction === 1;
                    const probability = pred.probability !== null ? (pred.probability * 100).toFixed(2) : 'N/A';
                    const riskLevel = pred.probability > 0.5 ? t('highRisk') : pred.probability > 0.3 ? t('mediumRisk') : t('lowRisk');
                    const riskClass = pred.probability > 0.5 ? 'risk-high' : pred.probability > 0.3 ? 'risk-medium' : 'risk-low';
                    
                    organHtml += `
                        <div class="combination-item" style="background: ${isAbnormal ? '#fee' : '#efe'}; border-left: 4px solid ${isAbnormal ? '#dc3545' : '#28a745'};">
                            <h4>${organ.name} ${t('predictionResult')}</h4>
                            <p style="color: #666; font-size: 12px; margin-bottom: 15px;">${organ.desc}</p>
                            <div style="margin: 15px 0;">
                                <p><strong>${t('predictionStatus')}:</strong> 
                                    <span class="risk-badge ${riskClass}" style="font-size: 14px; margin-left: 10px;">
                                        ${isAbnormal ? `âš ï¸ ${t('abnormal')}` : `âœ… ${t('normal')}`}
                                    </span>
                                </p>
                                <p><strong>${t('abnormalProbability')}:</strong> <span style="font-size: 18px; font-weight: bold; color: ${isAbnormal ? '#c33' : '#155724'};">${probability}%</span></p>
                                <p><strong>${t('riskLevel')}:</strong> ${riskLevel}</p>
                            </div>
                            ${isAbnormal ? 
                                `<p style="color: #c33; font-weight: bold; padding: 10px; background: #fff3cd; border-radius: 5px;">âš ï¸ ${t('suggestMonitor')}</p>` : 
                                `<p style="color: #155724; padding: 10px; background: #d4edda; border-radius: 5px;">âœ… ${t('predictionNormal')}</p>`}
                        </div>
                    `;
                } else {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯APIé”™è¯¯
                    const hasError = predictions && predictions.error;
                    const errorMsg = hasError ? predictions.error : t('modelNotLoaded');
                    
                    organHtml += `
                        <div class="combination-item" style="background: #fff3cd; border-left: 4px solid #ffc107;">
                            <h4>${organ.name} ${t('predict')}</h4>
                            <p style="color: #856404; margin-bottom: 10px;">
                                âš ï¸ ${errorMsg}
                            </p>
                            <div style="background: white; padding: 10px; border-radius: 5px; margin-top: 10px;">
                                <p style="font-size: 12px; color: #666; margin-bottom: 5px;"><strong>${t('solution')}ï¼š</strong></p>
                                <ol style="font-size: 12px; color: #666; margin-left: 20px; padding-left: 0;">
                                    <li>${t('checkApiRunning')}</li>
                                    <li>${t('checkApiHealth')}: <a href="http://localhost:5003/health" target="_blank">http://localhost:5003/health</a></li>
                                    <li>${t('restartApi')}: <code>python3 cdss_api.py</code></li>
                                    <li>${t('checkApiLogs')}</li>
                                </ol>
                            </div>
                        </div>
                    `;
                }
                
                // æ˜¾ç¤ºç›¸å…³çš„è¯ç‰©ç»„åˆåˆ†æ
                const risky = analysis.risky_combinations || [];
                const effective = analysis.effective_combinations || [];
                
                if (risky.length > 0) {
                    organHtml += `<h4 style="color: #c33; margin-top: 20px;">âš ï¸ ${t('riskyCombinations')}</h4>`;
                    risky.forEach(combo => {
                        organHtml += `
                            <div class="combination-item">
                                <h4>${combo.drug1} + ${combo.drug2}</h4>
                                <p><strong>${t('relativeRisk')}:</strong> ${combo.relative_risk.toFixed(2)}</p>
                                <p>${translateInterpretation(combo.interpretation || '')}</p>
                            </div>
                        `;
                    });
                }
                
                if (effective.length > 0) {
                    organHtml += `<h4 style="color: #155724; margin-top: 20px;">âœ… ${t('effectiveCombinations')}</h4>`;
                    effective.forEach(combo => {
                        organHtml += `
                            <div class="combination-item">
                                <h4>${combo.drug1} + ${combo.drug2}</h4>
                                <p><strong>${t('relativeRisk')}:</strong> ${combo.relative_risk.toFixed(2)}</p>
                                <p>${translateInterpretation(combo.interpretation || '')}</p>
                            </div>
                        `;
                    });
                }
                
                if (risky.length === 0 && effective.length === 0 && (!predictions || !predictions.predictions)) {
                    organHtml += `<p style="color: #666; padding: 20px;">${t('noData')}</p>`;
                }
                
                organHtml += '</div>';
                contentHtml += organHtml;
            });
            
            document.getElementById('outcomeTabs').innerHTML = tabsHtml;
            document.getElementById('outcomeContent').innerHTML = contentHtml;
            
            // å»ºè®®å’Œæ¨èè¯ç‰©
            let recommendationsHtml = '';
            
            // æ˜¾ç¤ºä¸´åºŠå»ºè®®
            if (analysis.recommendations && analysis.recommendations.length > 0) {
                recommendationsHtml += `
                    <h4>ğŸ’¡ ${t('clinicalRecommendations')}</h4>
                    <ul>
                        ${analysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                `;
            }
            
            // æ˜¾ç¤ºæ¨èè¯ç‰©ï¼ˆå¦‚æœé¢„æµ‹åˆ°é«˜é£é™©æˆ–ä¸­ç­‰é£é™©ï¼‰
            const hasHighRisk = predictions && predictions.predictions && 
                Object.values(predictions.predictions).some(p => 
                    p.prediction === 1 || (p.probability && p.probability > 0.2)
                );
            
            // æˆ–è€…å¦‚æœè¯ç‰©ç»„åˆåˆ†ææ˜¾ç¤ºé«˜é£é™©
            const hasCombinationRisk = analysis.overall_risk === 'high' || analysis.overall_risk === 'medium';
            
            const shouldShowRecommendations = (hasHighRisk || hasCombinationRisk) && 
                                             recommendations && recommendations.success && 
                                             recommendations.recommendations.length > 0;
            
            if (shouldShowRecommendations) {
                recommendationsHtml += `
                    <h4 style="margin-top: 20px; color: #0c5460;">ğŸ’Š ${t('preventOrganDysfunction')}</h4>
                    <p style="color: #666; font-size: 12px; margin-bottom: 15px;">
                        ${t('basedOnAnalysis')}ï¼š
                    </p>
                    ${hasHighRisk ? `<p style="color: #c33; font-size: 12px; margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 5px;">âš ï¸ ${t('detectedRisk')}</p>` : ''}
                    <div style="display: grid; gap: 10px;">
                        ${recommendations.recommendations.map(rec => `
                            <div class="combination-item" style="background: #d1ecf1; border-left: 4px solid #0c5460;">
                                <h4 style="color: #0c5460; margin-bottom: 8px;">
                                    ${rec.drug}
                                    ${rec.best_combo_with ? `<span style="font-size: 12px; color: #666;">(${currentLanguage === 'zh' ? `${t('comboWith')} ${rec.best_combo_with} ${t('comboWithSuffix')}` : currentLanguage === 'fr' ? `${t('comboWith')} ${rec.best_combo_with} ${t('comboWithSuffix')}` : `${t('comboWith')} ${rec.best_combo_with} ${t('comboWithSuffix')}`})</span>` : ''}
                                </h4>
                                <p style="color: #0c5460; margin: 5px 0;">
                                    <strong>${t('recommendedReason')}:</strong> ${rec.reason || rec.potential_benefit || (currentLanguage === 'zh' ? 'å¯èƒ½é™ä½å™¨å®˜åŠŸèƒ½å¼‚å¸¸é£é™©' : currentLanguage === 'fr' ? 'Peut rÃ©duire le risque de dysfonctionnement d\'organe' : 'May reduce organ dysfunction risk')}
                                </p>
                                ${rec.risk_reduction > 0 ? `
                                    <p style="color: #0c5460; font-size: 12px; margin-top: 5px;">
                                        ${t('potentialRiskReduction')}: ${(rec.risk_reduction * 100).toFixed(1)}%
                                    </p>
                                ` : ''}
                                <button onclick="addRecommendedDrug('${rec.drug}')" 
                                        style="margin-top: 10px; padding: 6px 15px; background: #0c5460; color: white; 
                                               border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                    â• ${t('addThisDrug')}
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    <p style="color: #999; font-size: 11px; margin-top: 15px;">
                        ${t('noteRecommendations')}
                    </p>
                `;
            } else if (hasHighRisk || hasCombinationRisk) {
                recommendationsHtml += `
                    <h4 style="margin-top: 20px; color: #856404;">ğŸ’Š ${t('drugRecommendation')}</h4>
                    <p style="color: #666;">${t('noRecommendationData')}</p>
                    <p style="color: #999; font-size: 11px; margin-top: 10px;">
                        ${t('suggestionAntioxidant')}
                    </p>
                `;
            }
            
            if (recommendationsHtml) {
                document.getElementById('recommendations').innerHTML = recommendationsHtml;
            }
            
            // æ˜¾ç¤ºç»“æœ
            document.getElementById('results').classList.add('show');
        }
        
        // æ·»åŠ æ¨èè¯ç‰©
        function addRecommendedDrug(drug) {
            if (!selectedDrugs.includes(drug)) {
                selectedDrugs.push(drug);
                updateSelectedDrugs();
                // æ»šåŠ¨åˆ°å·²é€‰è¯ç‰©åŒºåŸŸ
                document.getElementById('selectedDrugs').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                alert(t('drugAlreadySelected'));
            }
        }
        
        // åˆ‡æ¢å™¨å®˜ç±»å‹
        function switchOrgan(organId) {
            currentOrgan = organId;
            
            // æ›´æ–°æ ‡ç­¾é¡µ
            document.querySelectorAll('.outcome-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // æ›´æ–°å†…å®¹
            document.querySelectorAll('.outcome-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`organ-${organId}`).classList.add('active');
        }
        
        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            document.getElementById('error').textContent = message;
            document.getElementById('error').style.display = 'block';
        }
        
        </script>
    </body>
</html>

